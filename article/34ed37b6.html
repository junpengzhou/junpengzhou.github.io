<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>Spring Reactor实战之Mono与Flux | AlphaDog</title><meta name="keywords" content="Java,Spring"><meta name="author" content="Junpengzhou"><meta name="copyright" content="Junpengzhou"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Spring Reactor实战之Mono与Flux"><meta name="application-name" content="Spring Reactor实战之Mono与Flux"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="Spring Reactor实战之Mono与Flux"><meta property="og:url" content="https://www.junpengzhou.top/article/34ed37b6.html"><meta property="og:site_name" content="AlphaDog"><meta property="og:description" content="前言 响应式编程用的是越来越多，尤其是在移动端Android的应用上边 在Java后台服务开发中， 响应式编程用的不是太广泛，主要原因是， 响应式编程需要一个完整的生态， 包括数据库、缓存、中间件，都需要配套的响应式组件，受到以上局限，因此响应式编程在服务端大规模运用的案例少之又少 但是随着 Spr"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/%E7%BA%BF%E6%9D%A1%E5%B0%8F%E7%8B%97-cover.webp"><meta property="article:author" content="Junpengzhou"><meta property="article:tag" content="技术,前端,后端,美食,工程管理,数学,英语,密码学,Java,Python,机器学习,AI,读书,播客,工具"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/%E7%BA%BF%E6%9D%A1%E5%B0%8F%E7%8B%97-cover.webp"><meta name="description" content="前言 响应式编程用的是越来越多，尤其是在移动端Android的应用上边 在Java后台服务开发中， 响应式编程用的不是太广泛，主要原因是， 响应式编程需要一个完整的生态， 包括数据库、缓存、中间件，都需要配套的响应式组件，受到以上局限，因此响应式编程在服务端大规模运用的案例少之又少 但是随着 Spr"><link rel="shortcut icon" href="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/jp-blog-favicon.ico"><link rel="canonical" href="https://www.junpengzhou.top/article/34ed37b6.html"><link rel="preconnect" href="//cdn.cbd.int"><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="google-site-verification" content="sW9184Qb84fbHTjaHMPEyw8qv4GpWmI2gD-tTp_s"><meta name="baidu-site-verification" content="codeva-4bOPbFwZfg"><meta name="msvalidate.01" content="xxx"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={linkPageTop:{enable:!0,title:"与众多博主共同进步",addFriendPlaceholder:"站点名称：\n网站地址：\n头像地址：\n站点描述：\n站点截图（可选）：\n"},peoplecanvas:void 0,postHeadAiDescription:void 0,diytitle:void 0,LA51:{enable:!0,ck:"3FWN3ZXqo0a6Z2Ev",LingQueMonitorID:"3FWN3ZXqo0a6Z2Ev"},greetingBox:void 0,twikooEnvId:"https://twikoo.junpengzhou.top",commentBarrageConfig:{enable:!0,maxBarrage:1,barrageTime:4e3,accessToken:"24abc38bb05941a9830b8495c2db7637",mailMd5:"CC9A3999333A6826AFEAF269B1C49D06"},music_page_default:"nav_music",root:"/",preloader:{source:3},friends_vue_info:{apiurl:"https://friendscircle.junpengzhou.top/"},navMusic:!0,mainTone:void 0,authorStatus:{skills:["🔨 全栈开发工程师","🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🏃 脚踏实地行动派","🧱 团队小组发动机"]},algolia:{appId:"S58UP7YT4C",apiKey:"ec54556c03e6ea9b3ecdb7332bf0d059",indexName:"blog_junpengzhoutop",hits:{per_page:10},languages:{input_placeholder:"输入关键词后按下回车查找",hits_empty:"找不到您查询的内容：${query}",hits_stats:"找到 ${hits} 条结果，用时 ${time} 毫秒"}},localSearch:void 0,translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"简",rightMenuMsgToTraditionalChinese:"转为繁体",rightMenuMsgToSimplifiedChinese:"转为简体"},noticeOutdate:{limitDay:365,position:"top",messagePrev:"It has been",messageNext:"days since the last update, the content of the article may be outdated."},highlight:{plugin:"highlight.js",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,simplehomepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{copy:!0,copyrightEbable:!0,limitCount:50,languages:{author:"作者: Junpengzhou",link:"链接: ",source:"来源: AlphaDog",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。",copySuccess:"复制成功，复制和转载请标注本文地址"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#3b70fc",bgDark:"#1f1f1f",position:"top-center"},source:{justifiedGallery:{js:"https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js",css:"https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!1,shortcutKey:void 0,autoDarkmode:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={configTitle:"AlphaDog",title:"Spring Reactor实战之Mono与Flux",postAI:"",pageFillDescription:"前言, 响应式编程概述, 背景知识, 什么是响应式编程, 基于Java8实现观察者模式, 创建一个Observable, 基于 Reactor 实现, 响应流的特点, Publisher/Flux和Mono, Flux, 传统数据处理, 流式数据处理, 反应式数据处理, Flux 的创建Demo, Mono, 传统数据处理, Optional的处理方式, 反应式数据处理, Mono的创建Demo, Flux和Mono总结, 函数编程, 函数编程接口, 常用函数编程示例, Flux类中的静态方法：, 简单的创建方法, 复杂的序列创建 generate(), 复杂的序列创建 create(), Mono静态方法, 操作符, 操作符buffer和bufferTimeout, 操作符Filter, 操作符zipWith, 操作符take, 操作符reduce和reduceWith, 操作符merge和mergeSequential, 操作符flatMap和flatMapSequential, 操作符concatMap, 操作符combineLatest, 消息处理, 调度器Scheduler, 测试, 调试, 日志记录, 冷热序列, ServerWebExchange交换机, ServerWebExchange与过滤器的关系：, 理解ServerWebExchange, ServerWebExchange接口, ServerWebExchangemutate()方法, ServerHttpRequest接口, ServerHttpResponse接口, ServerWebExchangeUtils和上下文属性, 修改请求体, 修改响应体, 参考文献前言响应式编程用的是越来越多尤其是在移动端的应用上边在后台服务开发中响应式编程用的不是太广泛主要原因是响应式编程需要一个完整的生态包括数据库缓存中间件都需要配套的响应式组件受到以上局限因此响应式编程在服务端大规模运用的案例少之又少但是随着的火爆在业务路由网关中应用响应式编程可以帮助我们更好的管理微服务的路由和处理因此响应式编程后端又变成了不可回避不得不去学习的技术响应式编程概述背景知识为了应对高并发服务器端开发场景在年微软提出了一个更优雅地实现异步编程的方式我们称之为响应式编程随后和公司提供了和等技术使得平台也有了能够实现响应式编程的框架在年月日正式发布发布最大的意义在于它将响应式编程技术的普及向前推进了一大步而同时作为在背后支持响应式编程的框架也进入了里程碑式的版本什么是响应式编程响应式编程是一种面向数据流和变化传播的编程范式这意味着可以在编程语言中很方便地表达静态或动态的数据流而相关的计算模型会自动将变化的值通过数据流进行传播响应式编程基于是一个运行在之上的响应式框架的思想当你做一个带有一定延迟的才能够返回的操作时不会阻塞而是立刻返回一个流并且订阅这个流当这个流上产生了返回数据可以立刻得到通知并调用回调函数处理数据电子表格程序就是响应式编程的一个例子单元格可以包含字面值或类似的公式而包含公式的单元格的值会依据其他单元格的值的变化而变化响应式传播核心特点之一变化传播一个单元格变化之后会像多米诺骨牌一样导致直接和间接引用它的其他单元格均发生相应变化基于实现观察者模式类此类表示可观察对象或模型视图范例中的数据它可以被子类实现以表示应用程序想要观察的对象想要观察的对象添加观察者数据发生变化数据发生变化将此对象标记为已更改如果该对象发生了变化则通知其所有观察者启动程序测试创建一个出品的一个响应式编程开发库中可以使用该方法接收一个对象来个例子订阅了完成异常接收中发射的值输出接收中发射的值接收中发射的值接收中发射的值接收中发射的值接收中发射的值从上面的例子可以看出在订阅了后作为中方法的参数传入从而调用了的相关方法基于实现是一个运行在之上满足规范的响应式框架它提供了一组响应式风格的有两个核心类和这两个类都实现接口类似的它可以触发零到多个事件并根据实际情况结束处理或触发错误最多只触发一个事件所以可以把用于在异步任务完成时发出通知和都是数据流的发布者使用和都可以发出三种数据信号元素值错误信号完成信号错误信号和完成信号都代表终止信号终止信号用于告诉订阅者数据流结束了错误信号终止数据流同时把错误信息传递给订阅者三种信号的特点错误信号和完成信号都是终止信号不能共存如果没有发送任何元素值而是直接发送错误或者完成信号表示是空数据流如果没有错误信号也没有完成信号表示是无限数据流引入依赖和方法创建序列并声明指定数据流订阅序列只有进行订阅后才回触发数据流不订阅就什么都不会发生创建序列并声明数据流整形订阅序列只有进行订阅后才回触发数据流不订阅就什么都不会发生字符串和可以从一个数组对象或对象中创建序列启动测试响应流的特点要搞清楚这两个概念必须说一下响应流规范它是响应式编程的基石他具有以下特点响应流必须是无阻塞的响应流必须是一个数据流它必须可以异步执行并且它也应该能够处理背压即时响应性只要有可能系统就会及时地做出响应即时响应是可用性和实用性的基石而更加重要的是即时响应意味着可以快速地检测到问题并且有效地对其进行处理即时响应的系统专注于提供快速而一致的响应时间确立可靠的反馈上限以提供一致的服务质量这种一致的行为转而将简化错误处理建立最终用户的信任并促使用户与系统作进一步的互动回弹性系统在出现失败时依然保持即时响应性这不仅适用于高可用的任务关键型系统任何不具备回弹性的系统都将会在发生失败之后丢失即时响应性回弹性是通过复制遏制隔离以及委托来实现的失败的扩散被遏制在了每个组件内部与其他组件相互隔离从而确保系统某部分的失败不会危及整个系统并能独立恢复每个组件的恢复都被委托给了另一个外部的组件此外在必要时可以通过复制来保证高可用性因此组件的客户端不再承担组件失败的处理弹性系统在不断变化的工作负载之下依然保持即时响应性反应式系统可以对输入负载的速率变化做出反应比如通过增加或者减少被分配用于服务这些输入负载的资源这意味着设计上并没有争用点和中央瓶颈得以进行组件的分片或者复制并在它们之间分布输入负载通过提供相关的实时性能指标反应式系统能支持预测式以及反应式的伸缩算法这些系统可以在常规的硬件以及软件平台上实现成本高效的弹性消息驱动反应式系统依赖异步的消息传递从而确保了松耦合隔离位置透明的组件之间有着明确边界这一边界还提供了将失败作为消息委托出去的手段使用显式的消息传递可以通过在系统中塑造并监视消息流队列并在必要时应用回压从而实现负载管理弹性以及流量控制使用位置透明的消息传递作为通信的手段使得跨集群或者在单个主机中使用相同的结构成分和语义来管理失败成为了可能非阻塞的通信使得接收者可以只在活动时才消耗资源从而减少系统开销和由于响应流的特点我们不能再返回一个简单的对象来表示结果了必须返回一个类似中的的概念在有结果可用时通知消费者进行消费响应规范中这种被定义为是一个可以提供个序列元素的提供者并根据其订阅者的需求推送元素一个可以支持多个订阅者并可以根据订阅者的逻辑进行推送序列元素下面这个计算就能说明一些的特点就可以看做及其提供的元素序列分别是求和函数平均函数最大值函数最小值函数可以看作订阅者假如说我们没有那么就没有实际意义它们并不产生计算这也是响应式的一个重要特点当没有订阅时发布者什么也不做而和都是在实现提供了方法允许消费者在有结果可用时进行消费如果没有消费者不会做任何事情他根据消费情况进行响应可能返回零或者多个甚至可能是无限的为了更加清晰表示期待的结果就引入了两个实现模型和是一个发出个元素组成的异步序列的可以被信号或者信号所终止在响应流规范中存在三种给下游消费者调用的方法和下面这张图表示了的抽象模型以上的的讲解对于初次接触反应式编程的依然是难以理解的所以这里有一个循序渐进的理解过程有些类比并不是很妥当但是对于你循序渐进的理解这些新概念还是有帮助的传统数据处理我们在平常是这么写的我们通过迭代返回值来这些元素进行再处理消费不管有没有消费者菜品都会生产出来流式数据处理在中我们可以改写为流的表示反应式数据处理在中我们又可以改写为表示这时候食客来了发生了订阅厨师才开始做的创建是一个发出个元素的可以被信号或者信号所终止整体和差不多只不过这里只会发出个元素也就是说不是有就是没有象一样我们来看看的演化过程以帮助理解传统数据处理直接返回符合条件的对象或者的处理方式这个我觉得就有反应式的那种味儿了当然它并不是反应式当我们不从返回值取其中具体的对象时我们不清楚里面到底有没有但是是一定客观存在的不会出现问题反应式数据处理和有点类似的机制当然不是为了解决问题的它是为了处理响应流中单个值也可能是而存在的的创建和总结和是反应式中的重要概念但是很多同学包括我在开始都难以理解它们这其实是规定了两种流式范式这种范式让数据具有一些新的特性比如基于发布订阅的事件驱动异步流背压等等另外数据是推送给消费者的以区别于平时我们的拉模式同时我们可以像一样使用类似等操作符来操作它们说明本文会以格式持续更新更多最新尼恩高笔记请从下面的链接获取语雀或者码云函数编程反应式编程常常和函数式编程结合这就是让大家困扰的地方函数编程接口接口函数名说明表示接收两个输入参数和不返回结果的操作表示接受两个参数并产生一个结果的函数表示在相同类型的两个操作数的操作生产相同类型的操作数的结果代表两个参数谓词布尔值函数代表布尔值结果的提供者表示接受一个输入参数和不返回结果的操作代表在两个值操作数的运算并产生一个值结果表示接受一个值参数不返回结果的操作表示接受值参数并产生一个结果的函数代表一个值参数谓词布尔值函数表示表示接受值参数并产生一个结果的函数值结果的提供者表示接受一个值参数不返回结果的操作表示接受值参数并产生一个结果的函数代表一个值参数谓词布尔值函数表示接受值参数并产生一个值结果的函数表示上产生一个值结果的单个值操作数的操作代表接受一个值参数并产生一个值结果的函数表示上产生一个值结果的单个值操作数的操作表示接受一个参数并产生一个结果的函数表示接受单个值的参数并没有返回结果的操作表示接受一个值参数并产生一个结果的函数表示一个整数值参数谓词布尔值函数代表整型值的结果的提供者表示接受一个值参数并产生一个值结果的函数表示产生一个值结果的单个值操作数的运算表示在两个值操作数的操作并产生一个值结果表示接受值参数并产生一个结果的函数代表一个值参数谓词布尔值函数表示值结果的提供者表示接受参数并产生一个值结果的函数表示接受值参数并产生一个值结果的函数表示上产生一个值结果单一的值操作数的操作表示接受对象值和值参数并且没有返回结果的操作表示接受对象值和整型值参数并返回没有结果的操作表示接受对象值和整型值参数并返回没有结果的操作表示接受对象值和值参数并且没有返回结果的操作表示接受对象值和整型值参数并返回没有结果的操作表示接受对象的值和值的说法并没有返回结果的操作代表一个参数谓词布尔值函数表示一个提供者的结果表示接受两个参数并产生一个值结果的功能代表一个产生一个值结果的功能表示接受两个参数并产生一个值结果的函数代表产生一个值结果的功能表示接受两个参数并产生值结果的功能代表一个产生值结果的功能表示上产生相同类型的操作数的结果的单个操作数的操作常用函数编程示例一个输入无输出类名静态方法一个输入没有输出方法引用一个输入一个输出对象方法一个输入一个输出剩余库存带参数的构造函数新对象一个输入一个输出一个输入一个输出库存是否足够方法引用库存是否足够一元操作符输入输出都是一元操作符输入和输出剩余库存剩余库存没有输入只有输出无参数构造函数创建新对象剩余库存二元操作符两个输入一个输出类名方法剩余库存二元操作符二个输入一个输出剩余库存说明本文会以格式持续更新更多最新尼恩高笔记请从下面的链接获取语雀或者码云类中的静态方法简单的创建方法可以指定序列中包含的全部元素创建出来的序列在发布这些元素之后会自动结束可以从一个数组对象或对象中穿件对象创建一个不包含任何元素只发布结束消息的序列创建一个只包含错误消息的序列传建一个不包含任务消息通知的序列创建包含从起始的个数量的对象的序列和创建一个包含了从开始递增的对象的序列其中包含的元素按照指定的间隔来发布除了间隔时间之外还可以指定起始元素发布之前的延迟时间和与方法相同但该方法通过毫秒数来指定时间间隔和延迟时间例子复杂的序列创建当序列的生成需要复杂的逻辑时则应该使用或方法方法通过同步和逐一的方式来产生序列序列的产生是通过调用所提供的的对象的和方法来完成的逐一生成的含义是在具体的生成逻辑中方法只能最多被调用一次在某些情况下序列的生成可能是有状态的需要用到某些状态对象此时可以使用其中用来提供初始的状态对象在进行序列生成时状态对象会作为使用的第一个参数传入可以在对应的逻辑中对改状态对象进行修改以供下一次生成时使用复杂的序列创建方法与方法的不同之处在于所使用的是对象支持同步和异步的消息产生并且可以在一次调用中产生多个元素静态方法类包含了与类中相同的静态方法和等除此之外还有一些独有的静态方法和分别从和中创建和创建一个序列在指定的延迟时间之后产生数字作为唯一值创建一个序列忽略作为源的中的所有元素只产生消息和从一个对象或可能为的对象中创建只有对象中包含之或对象不为时序列才产生对应的元素说明本文会以格式持续更新更多最新尼恩高笔记请从下面的链接获取语雀或者码云操作符操作符和这两个操作符的作用是把当前流中的元素收集到集合中并把集合对象作为流中的新元素在进行收集时可以指定不同的条件所包含的元素的最大数量或收集的时间间隔方法仅使用一个条件而可以同时指定两个条件指定时间间隔时可以使用对象或毫秒数即使用或两个方法除了元素数量和时间间隔外还可以通过和操作符来进行收集这两个操作符的参数时表示每个集合中的元素索要满足的条件的对象会一直收集直到返回使得返回的那个元素可以选择添加到当前集合或下一个集合中则只有当返回时才会收集一旦为会立即开始下一次收集操作符对流中包含的元素进行过滤只留下满足指定条件的元素操作符操作符把当前流中的元素与另一个流中的元素按照一对一的方式进行合并在合并时可以不做任何处理由此得到的是一个元素类型为的流也可以通过一个函数对合并的元素进行处理所得到的流的元素类型为该函数的返回值操作符系列操作符用来从当前流中提取元素提取方式如下和按照指定的数量或时间间隔来提取提取流中的最后个元素提取元素直到返回当返回时才进行提取提取元素知道另外一个流开始产生元素操作符和和操作符对流中包含的所有元素进行累计操作得到一个包含计算结果的序列累计操作是通过一个来表示的在操作时可以指定一个初始值若没有初始值则序列的第一个元素作为初始值操作符和和操作符用来把多个流合并成一个序列按照所有流中元素的实际产生序列来合并而按照所有流被订阅的顺序以流为单位进行合并操作符和和操作符把流中的每个元素转换成一个流再把所有流中的元素进行合并和之间的区别与和是一样的操作符操作符的作用也是把流中的每个元素转换成一个流再把所有流进行合并会根据原始流中的元素顺序依次把转换之后的流进行合并并且堆转换之后的流的订阅是动态进行的而在合并之前就已经订阅了所有的流操作符操作符把所有流中的最新产生的元素合并成一个新的元素作为返回结果流中的元素只要其中任何一个流中产生了新的元素合并操作就会被执行一次结果流中就会产生新的元素消息处理当需要处理或中的消息时可以通过方法来添加相应的订阅逻辑在调用方法时可以指定需要处理的消息类型第种可以通过方法来使用另外的流来产生元素第种是通过方法来根据不同的异常类型来选择要使用的产生元素的流当出现错误时还可以使用操作符来进行重试重试的动作是通过重新订阅序列来实现的在使用操作时还可以指定重试的次数说明本文会以格式持续更新更多最新尼恩高笔记请从下面的链接获取语雀或者码云调度器通过调度器可以指定操作执行的方式和所在的线程有以下几种不同的调度器实现当前线程通过方法来创建单一的可复用的线程通过方法来创建使用弹性的线程池通过方法来创建线程池中的线程是可以复用的当所需要时新的线程会被创建若一个线程闲置时间太长则会被销毁该调度器适用于操作相关的流的处理使用对并行操作优化的线程池通过方法来创建其中的线程数量取决于的核的数量该调度器适用于计算密集型的流的处理使用支持任务调度的调度器通过方法来创建从已有的对象中创建调度器通过方法来创建通过和方法可以切换执行操作调度器方法切换的是操作符的执行方式而方法切换的是产生流中元素时的执行方式测试的作用是可以对序列中包含的元素进行逐一验证通过方法对一个流进行包装之后再进行验证方法用来声明测试时所期待的流中的下一个元素的值而方法则验证流是否正常结束来验证流由于错误而终止使用方法可以创建出使用虚拟时钟的通过方法可以让虚拟时钟前进的作用在于可以控制流中元素的产生甚至是违反反应流规范的情况通过方法创建一个新的对象然后使用方法来产生元素使用方法来结束流调试在调试模式启用之后所有的操作符在执行时都会保存额外的与执行链相关的信息当出现错误时这些信息会被作为异常堆栈信息的一部分输出也可以通过操作符来对特定的流处理链来启用调试模式日志记录可以通过添加操作把流相关的事件记录在日志中冷热序列冷序列的含义是不论订阅者在何时订阅该序列总是能收到序列中产生的全部消息热序列是在持续不断的产生消息订阅者只能获取到在其订阅之后产生的消息说明本文会以格式持续更新更多最新尼恩高笔记请从下面的链接获取语雀或者码云交换机与过滤器的关系同类似有和两种方式的客户端的请求先经过类型的然后将请求转发到具体的业务服务收到业务服务的响应之后再经过类型的处理最后返回响应到客户端引用官网上的一张图与不同的是除了分为和两种方式的外在中从作用范围可分为另外两种一种是针对于单个路由的它在配置文件中的写法同类似一种是针对于所有路由的现在从作用范围划分的维度来讲解这两种我们在使用的时候注意到过滤器包括和过滤器链根据作用范围划分为和二者区别如下需要通过配置在具体路由下只作用在当前路由上或通过配置在全局作用在所有路由上全局过滤器不需要在配置文件中配置作用在所有的路由上最终通过包装成可识别的过滤器它为请求业务以及路由的转换为真实业务服务的请求地址的核心过滤器不需要配置系统初始化时加载并作用在每个路由上框架内置的如下上图中每一个都作用在每一个上能够满足大多数的需求但是如果遇到业务上的定制可能需要编写满足自己需求的过滤器都依赖到这里的设计和中的是相似的当前过滤器可以决定是否执行下一个过滤器的逻辑由是否被调用来决定而就相当于当前请求和响应的上下文实例不单存储了和对象还提供了一些扩展方法如果想实现改造请求参数或者响应参数就必须深入了解理解先看的注释翻译一下大概是是一个请求响应交互的契约提供对请求和响应的访问并公开额外的服务器端处理相关属性和特性如请求属性其实命名为服务网络交换器存放着重要的请求响应属性请求实例和响应实例等等有点像的角色接口接口的所有方法日志前缀属性的值为可以理解为日志前缀的具体值作用是打印日志的时候会拼接这个对饮的前缀值默认值为获取对象获取对象返回当前的请求属性返回结果是一个可变的根据获取请求属性根据获取请求属性做了非空判断根据获取请求属性需要提供默认值返回当前请求的网络会话返回当前请求的认证用户如果存在的话返回请求的表单数据或者一个空的只有为的时候这个方法才会返回一个非空的这个一般是表单数据提交用到返回请求的数据或者一个空的只有为的时候这个方法才会返回一个非空的这个一般是文件上传用到返回的上下文这几个方法和属性相关转换转换映射注意这个方法方法名是改变这个是修改属性的方法返回的是一个实例是的内部类覆盖覆盖覆盖当前请求的认证用户构建新的实例方法注意到方法实例可以理解为不可变实例如果我们想要修改它需要通过方法生成一个新的实例例如这样这里可以修改实例这里可以修改实例构建新的实例接口实例是用于承载请求相关的属性和请求体中底层使用处理网络请求通过追溯源码可以从中得知实例中持有的实例的具体实现是之所以列出这些实例之间的关系是因为这样比较容易理清一些隐含的问题例如的父类中初始化内部属性的时候把请求的头部封装为只读的实例类中的方法屏蔽了所有修改请求头的方法直接抛出所以不能直接从实例中直接获取请求头实例并且进行修改接口如下获取请求头目前的实现中返回的是实例只读返回请求体的封装返回请求方法解析为实例返回请求方法字符串请求的连接的唯一标识或者用于日志处理标识获取请求路径封装为对象返回查询参数是只读的实例返回集合是只读的实例远程服务器地址信息会话实现的相关信息修改请求的方法返回一个建造器实例是内部类覆盖请求方法覆盖请求的请求路径或者上下文这三者相互有制约关系具体可以参考注释覆盖请求头覆盖构建一个新的实例注意或者说接口提供的获取请求头方法返回结果是一个只读的实例具体是类型如果要修改实例那么需要这样做接口实例是用于承载响应相关的属性和响应体中底层使用处理网络请求通过追溯源码可以从中得知实例中持有的实例的具体实现是之所以列出这些实例之间的关系是因为这样比较容易理清一些隐含的问题例如的父类可知构造函数初始化实例的时候存放响应的是实例也就是响应是可以直接修改的接口如下获取响应目前的实现中返回的是实例可以直接修改获取实例用于包装或者生成数据缓冲区实例创建响应体注册一个动作在提交之前此动作会进行回调判断是否已经提交写入消息体到协议层写入消息体到协议层并且刷新缓冲区指明消息处理已经结束一般在消息处理结束自动调用此方法多次调用不会产生副作用设置响应状态码获取响应状态码获取响应封装为实例可以修改添加响应这里可以看到除了响应体比较难修改之外其他的属性都是可变的和上下文属性里面存放了很多静态公有的字符串值这些字符串的实际值是下面任意的静态公有这些字符串值一般是用于的属性见上文的方法的这些属性值都是有特殊的含义在使用过滤器的时候如果时机适当可以直接取出来使用下面逐个分析是否保存属性值是布尔值类型写入位置是使用的位置是作用是如果设置为请求头中的属性会写到底层的请求属性中保存底层的响应对象类型是保存底层的连接对象类型是解析路径参数完成之后把解析完成后的占位符路径映射存放在的属性中就是保存底层的响应的名称集合用于存放中匹配出来的具体的路由实例通过这个路由实例可以得知当前请求会路由到下游哪个服务类型的实例这个实例代表直接请求或者负载均衡处理之后需要请求到下游服务的真实类型的实例需要重写请求的时候保存原始的请求保存当前使用的具体实例的类型简称一般是字符串确定目标路由中如果存在属性则保存该的在此属性中路由会被重新构造见用于存放中匹配出来的具体的路由实例的实验性功能此版本还不建议在正式版本使用存放分组权重相关属性见存放响应中的的值的实例存放的是执行异常时候的异常实例见布尔值用于判断是否已经进行了路由见布尔值用于判断请求路径是否被添加了前置部分见提供的上下文属性用于的组件处理请求和响应的时候内部一些重要实例或者标识属性的安全传输和使用使用它们可能存在一定的风险因为没有人可以确定在版本升级之后原有的属性或者是否会发生改变如果评估过风险或者规避了风险之后可以安心使用例如我们在做请求和响应日志类似的的时候可以依赖到因为我们要打印路由的目标信息举个简单例子获取路由的目标请求路径客户端远程地址请求方法目标响应码修改请求体修改请求体是一个比较常见的需求例如我们使用实现网关的时候要实现一个功能把存放在请求头中的解析后提取里面的用户然后写入到请求体中我们简化这个场景假设我们把明文存放在请求头中的中请求体是一个结构请求流水号这里是有效载荷存放具体的数据我们需要提取也就是插入到请求体中如下用户请求流水号这里是有效载荷存放具体的数据这里为了简化设计用全局过滤器实现实际需要结合具体场景考虑新建一个装饰器覆盖需要装饰的方法解析的节点格式异常节点最外层写入新的属性最终的数据为使用修改后的重新生成一个新的测试一下请求流水号日志输出最终的数据为请求流水号最重要的是用到了装饰器主要覆盖对应获取请求体数据缓冲区的方法即可至于怎么处理其他逻辑需要自行考虑这里只是做一个简单的示范一般的代码逻辑如下拿到承载原始请求体的这里通过自定义方式生成新的承载请求体的修改响应体修改响应体的需求也是比较常见的具体的做法和修改请求体差不多例如我们想要实现下面的功能第三方服务请求经过网关原始报文是密文我们需要在网关实现密文解密然后把解密后的明文路由到下游服务下游服务处理成功响应明文需要在网关把明文加密成密文再返回到第三方服务现在简化整个流程用加密算法统一密码为字符串假设请求报文和响应报文明文如下请求密文请求流水号加密后的请求消息载荷请求明文仅仅作为提示请求流水号响应密文加密后的响应消息载荷响应明文仅仅作为提示为了方便一些加解密或者编码解码的实现需要引入的类库这里定义一个全局过滤器专门处理加解密实际上最好结合真实的场景决定是否适合全局过滤器这里只是一个示例加解密工具类单例响应体修改请求体修改前修改后修改响应体修改前修改后先准备一份密文请求流水号输出请求流水号模拟请求请求流水号响应结果请求流水号解密后遇到的问题必须实现接口返回一个小于的值这是因为的值为我们需要覆盖返回响应体的逻辑自定义的必须比优先执行网关每次重启之后第一个请求总是无法从原始的读取到有效的准确来说出现的现象是调用的时候获取到一个空的对象导致空指针奇怪的是从第二个请求开始就能正常调用笔者把的版本降低到的版本降低到问题不再出现初步确定是版本升级导致的兼容性问题或者是最重要的是用到了装饰器主要覆盖写入响应体数据缓冲区的部分至于怎么处理其他逻辑需要自行考虑这里只是做一个简单的示范一般的代码逻辑如下就是原始的响应数据的缓冲区下面处理完毕之后返回新的响应数据的缓冲区即可参考文献",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-12-18 14:26:38",postMainColor:""}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:(e,t,a)=>{if(0===a)return;const o={value:t,expiry:Date.now()+864e5*a};localStorage.setItem(e,JSON.stringify(o))},get:e=>{const t=localStorage.getItem(e);if(!t)return;const a=JSON.parse(t);if(!(Date.now()>a.expiry))return a.value;localStorage.removeItem(e)}},e.getScript=(e,t={})=>new Promise(((a,o)=>{const c=document.createElement("script");c.src=e,c.async=!0,c.onerror=o,c.onload=c.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(c.onload=c.onreadystatechange=null,a())},Object.keys(t).forEach((e=>{c.setAttribute(e,t[e])})),document.head.appendChild(c)})),e.getCSS=(e,t=!1)=>new Promise(((a,o)=>{const c=document.createElement("link");c.rel="stylesheet",c.href=e,t&&(c.id=t),c.onerror=o,c.onload=c.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(c.onload=c.onreadystatechange=null,a())},document.head.appendChild(c)})),e.activateDarkMode=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#18171d")},e.activateLightMode=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#f7f9fe")};const t=saveToLocal.get("theme"),a=window.matchMedia("(prefers-color-scheme: dark)").matches,o=window.matchMedia("(prefers-color-scheme: light)").matches,c=window.matchMedia("(prefers-color-scheme: no-preference)").matches,n=!a&&!o&&!c;if(void 0===t){if(o)activateLightMode();else if(a)activateDarkMode();else if(c||n){const e=(new Date).getHours();e<=6||e>=18?activateDarkMode():activateLightMode()}window.matchMedia("(prefers-color-scheme: dark)").addListener((e=>{void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode():activateLightMode())}))}else"light"===t?activateLightMode():activateDarkMode();const d=saveToLocal.get("aside-status");void 0!==d&&("hide"===d?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><meta name="generator" content="Hexo 7.3.0"><style>mjx-container[jax=SVG]{direction:ltr}mjx-container[jax=SVG]>svg{overflow:visible}mjx-container[jax=SVG][display=true]{display:block;text-align:center;margin:1em 0}mjx-container[jax=SVG][justify=left]{text-align:left}mjx-container[jax=SVG][justify=right]{text-align:right}g[data-mml-node=merror]>g{fill:red;stroke:red}g[data-mml-node=merror]>rect[data-background]{fill:yellow;stroke:none}g[data-mml-node=mtable]>line[data-line]{stroke-width:70px;fill:none}g[data-mml-node=mtable]>rect[data-frame]{stroke-width:70px;fill:none}g[data-mml-node=mtable]>.mjx-dashed{stroke-dasharray:140}g[data-mml-node=mtable]>.mjx-dotted{stroke-linecap:round;stroke-dasharray:0,140}g[data-mml-node=mtable]>svg{overflow:visible}[jax=SVG] mjx-tool{display:inline-block;position:relative;width:0;height:0}[jax=SVG] mjx-tool>mjx-tip{position:absolute;top:0;left:0}mjx-tool>mjx-tip{display:inline-block;padding:.2em;border:1px solid #888;font-size:70%;background-color:#f8f8f8;color:#000;box-shadow:2px 2px 5px #aaa}g[data-mml-node=maction][data-toggle]{cursor:pointer}mjx-status{display:block;position:fixed;left:1em;bottom:1em;min-width:25%;padding:.2em .4em;border:1px solid #888;font-size:90%;background-color:#f8f8f8;color:#000}foreignObject[data-mjx-xml]{font-family:initial;line-height:normal;overflow:visible}.MathJax path{stroke-width:3}mjx-container[display=true]{overflow:auto hidden}mjx-container[display=true]+br{display:none}</style><link rel="alternate" href="/atom.xml" title="AlphaDog" type="application/atom+xml"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/avatar.png"><div class="loading-image-dot"></div></div></div><script>const preloader={endLoading:()=>{document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",(()=>{preloader.endLoading()})),setTimeout((function(){preloader.endLoading()}),1e4),document.addEventListener("pjax:send",(()=>{preloader.initLoading()})),document.addEventListener("pjax:complete",(()=>{preloader.endLoading()}))</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"><script async src="https://npm.elemecdn.com/pace-js@latest/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="/" title="博客"><img class="back-menu-item-icon" src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/jp-blog-favicon.ico" alt="博客"><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">关于</div><div class="back-menu-list"><a class="back-menu-item" href="/about/" title="关于作者"><img class="back-menu-item-icon" src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/avatar.png" alt="关于作者"><span class="back-menu-item-text">关于作者</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">AlphaDog</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)" rel="external nofollow noreferrer">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i> <span>总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i> <span>分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i> <span>标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>分享</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size:.9em"></i> <span>番剧分享</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/books/"><i class="anzhiyufont anzhiyu-icon-book faa-tada" style="font-size:.9em"></i> <span>读书分享</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/movies/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i> <span>电影分享</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/games/"><i class="anzhiyufont anzhiyu-icon-dice faa-tada" style="font-size:.9em"></i> <span>游戏分享</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/songs/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i> <span>音乐分享</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size:.9em"></i> <span>好物分享</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i> <span>友情链接</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size:.9em"></i> <span>博客快讯</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fishpound/"><i class="anzhiyufont anzhiyu-icon-fish faa-tada" style="font-size:.9em"></i> <span>博客鱼塘</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i> <span>留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i> <span>关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i> <span>网站公告</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i> <span>随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i> <span>搜索</span></a></div><input id="center-console" type="checkbox"><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole()"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/%E5%BE%AE%E4%BF%A1%E6%94%B6%E6%AC%BE%E7%A0%812.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/%E5%BE%AE%E4%BF%A1%E6%94%B6%E6%AC%BE%E7%A0%812.png"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/%E6%94%AF%E4%BB%98%E5%AE%9D%E6%94%B6%E6%AC%BE%E7%A0%812.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/%E6%94%AF%E4%BB%98%E5%AE%9D%E6%94%B6%E6%AC%BE%E7%A0%812.png"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title">最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">音乐</div><span class="author-content-item-title">灵魂的碰撞💥</span></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/12/"><span class="card-archive-list-date">十二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">11</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">十一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">九月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/08/"><span class="card-archive-list-date">八月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">11</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/05/"><span class="card-archive-list-date">五月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);" rel="external nofollow noreferrer"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/" itemprop="url">技术分享</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Java/" tabindex="-1" itemprop="url"><span><i class="anzhiyufont anzhiyu-icon-hashtag"></i> Java</span></a><a class="article-meta__tags" href="/tags/Spring/" tabindex="-1" itemprop="url"><span><i class="anzhiyufont anzhiyu-icon-hashtag"></i> Spring</span></a></span></div></div><h1 class="post-title" itemprop="name headline">Spring Reactor实战之Mono与Flux</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-12-17T07:33:24.000Z" title="发表于 2024-12-17 15:33:24">2024-12-17</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-12-18T06:26:38.000Z" title="更新于 2024-12-18 14:26:38">2024-12-18</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">13.6k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>51分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" data-flag-title="Spring Reactor实战之Mono与Flux"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/article/34ed37b6.html#post-comment" tabindex="-1"><span id="twikoo-count"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s58 18 88 18 58-18 88-18 58 18 88 18v44h-352Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/%E7%BA%BF%E6%9D%A1%E5%B0%8F%E7%8B%97-cover.webp"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://www.junpengzhou.top/article/34ed37b6.html"><header><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/" itemprop="url">技术分享</a><a href="/tags/Java/" tabindex="-1" itemprop="url">Java</a><a href="/tags/Spring/" tabindex="-1" itemprop="url">Spring</a><h1 id="CrawlerTitle" itemprop="name headline">Spring Reactor实战之Mono与Flux</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Junpengzhou</span><time itemprop="dateCreated datePublished" datetime="2024-12-17T07:33:24.000Z" title="发表于 2024-12-17 15:33:24">2024-12-17</time><time itemprop="dateCreated datePublished" datetime="2024-12-18T06:26:38.000Z" title="更新于 2024-12-18 14:26:38">2024-12-18</time></header><h2 id="前言">前言</h2><p>响应式编程用的是越来越多，尤其是在移动端Android的应用上边</p><p>在Java后台服务开发中， 响应式编程用的不是太广泛，主要原因是， 响应式编程需要一个完整的生态， 包括数据库、缓存、中间件，都需要配套的响应式组件，受到以上局限，因此响应式编程在服务端大规模运用的案例少之又少</p><p>但是随着 <code>Spring Cloud Gateway</code> 的火爆，在业务路由网关中应用响应式编程可以帮助我们更好的管理微服务的路由和IO处理，因此响应式编程后端又变成了不可回避， 不得不去学习的技术</p><h2 id="响应式编程概述">响应式编程概述</h2><h3 id="背景知识">背景知识</h3><p>为了应对高并发服务器端开发场景，在2009 年，微软提出了一个更优雅地实现异步编程的方式——Reactive Programming，我们称之为响应式编程。随后，Netflix 和LightBend 公司提供了RxJava 和Akka Stream 等技术，使得Java 平台也有了能够实现响应式编程的框架</p><p>在2017 年9 月28 日，Spring 5 正式发布。Spring 5 发布最大的意义在于，它将响应式编程技术的普及向前推进了一大步。而同时，作为在背后支持Spring 5 响应式编程的框架Spring Reactor，也进入了里程碑式的3.1.0 版本</p><h3 id="什么是响应式编程">什么是响应式编程</h3><p>响应式编程是一种面向数据流和变化传播的编程范式。这意味着可以在编程语言中很方便地表达静态或动态的数据流，而相关的计算模型会自动将变化的值通过数据流进行传播</p><p>响应式编程基于reactor（Reactor 是一个运行在 Java8 之上的响应式框架）的思想，当你做一个带有一定延迟的才能够返回的io操作时，不会阻塞，而是立刻返回一个流，并且订阅这个流，当这个流上产生了返回数据，可以立刻得到通知并调用回调函数处理数据</p><p>电子表格程序就是响应式编程的一个例子。单元格可以包含字面值或类似"=B1+C1"的公式，而包含公式的单元格的值会依据其他单元格的值的变化而变化</p><p>响应式传播核心特点之一：变化传播：一个单元格变化之后，会像多米诺骨牌一样，导致直接和间接引用它的其他单元格均发生相应变化</p><h3 id="基于java8实现观察者模式">基于Java8实现观察者模式</h3><p>Observable类：此类表示可观察对象，或模型视图范例中的“数据”</p><p>它可以被子类实现以表示应用程序想要观察的对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//想要观察的对象 ObserverDemo</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ObserverDemo</span> <span class="keyword">extends</span> <span class="title class_">Observable</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">ObserverDemo</span> <span class="variable">observerDemo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObserverDemo</span>();</span><br><span class="line">        <span class="comment">//添加观察者</span></span><br><span class="line">        observerDemo.addObserver((o,arg)-&gt;{</span><br><span class="line">            System.out.println(<span class="string">"数据发生变化A"</span>);</span><br><span class="line">        });</span><br><span class="line">        observerDemo.addObserver((o,arg)-&gt;{</span><br><span class="line">            System.out.println(<span class="string">"数据发生变化B"</span>);</span><br><span class="line">        });</span><br><span class="line">        observerDemo.setChanged();<span class="comment">//将此Observable对象标记为已更改</span></span><br><span class="line">        observerDemo.notifyObservers();<span class="comment">//如果该对象发生了变化，则通知其所有观察者</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>启动程序测试：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/e2c55c0a1df548f0af86c4e93f9b1ce3.png" alt="在这里插入图片描述"></p><h3 id="创建一个observable">创建一个Observable</h3><p><code>rxjava</code>(Netflix出品的一个响应式编程开发库)中，可以使用Observable.create() 该方法接收一个Obsubscribe对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Observable&lt;Integer&gt; observable = Observable.create(<span class="keyword">new</span> <span class="title class_">Observable</span>.OnSubscribe&lt;Integer&gt;() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(Subscriber&lt;? <span class="built_in">super</span> Integer&gt; subscriber)</span> {</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">});</span><br></pre></td></tr></table></figure><p>来个例子：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Observable&lt;Integer&gt; observable = Observable.create(<span class="keyword">new</span> <span class="title class_">Observable</span>.OnSubscribe&lt;Integer&gt;() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(Subscriber&lt;? <span class="built_in">super</span> Integer&gt; subscriber)</span> {</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++) {</span><br><span class="line">            subscriber.onNext(i);</span><br><span class="line">        }</span><br><span class="line">        subscriber.onCompleted();</span><br><span class="line">    }</span><br><span class="line">});</span><br><span class="line"><span class="comment">// Observable.subscribe(Observer)，Observer订阅了Observable</span></span><br><span class="line"><span class="type">Subscription</span> <span class="variable">subscribe</span> <span class="operator">=</span> observable.subscribe(<span class="keyword">new</span> <span class="title class_">Observer</span>&lt;Integer&gt;() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCompleted</span><span class="params">()</span> {</span><br><span class="line">        Log.e(TAG, <span class="string">"完成"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable e)</span> {</span><br><span class="line">        Log.e(TAG, <span class="string">"异常"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(Integer integer)</span> {</span><br><span class="line">        Log.e(TAG, <span class="string">"接收Obsverable中发射的值："</span> + integer);</span><br><span class="line">    }</span><br><span class="line">});</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">接收Obsverable中发射的值：0</span><br><span class="line">接收Obsverable中发射的值：1</span><br><span class="line">接收Obsverable中发射的值：2</span><br><span class="line">接收Obsverable中发射的值：3</span><br><span class="line">接收Obsverable中发射的值：4</span><br></pre></td></tr></table></figure><p>从上面的例子可以看出，在Observer订阅了Observable后，</p><p>Observer作为OnSubscribe中call方法的参数传入，从而调用了Observer的相关方法</p><h3 id="基于-reactor-实现">基于 Reactor 实现</h3><p>Reactor 是一个运行在 Java8 之上满足 Reactice 规范的响应式框架，它提供了一组响应式风格的 API。</p><p>Reactor 有两个核心类： <code>Flux&lt;T&gt;</code> 和 <code>Mono&lt;T&gt;</code>，这两个类都实现 Publisher 接口。</p><ul><li>Flux 类似 RxJava 的 Observable，它可以触发零到多个事件，并根据实际情况结束处理或触发错误。</li><li>Mono 最多只触发一个事件，所以可以把 Mono 用于在异步任务完成时发出通知。</li></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/2e5d2af3e0c94a1478b3dcff3f45c2be.png" alt="preview"></p><p>Flux 和 Mono 都是数据流的发布者，使用 Flux 和 Mono 都可以发出三种数据信号：元素值，错误信号，完成信号；错误信号和完成信号都代表终止信号，终止信号用于告诉订阅者数据流结束了，错误信号终止数据流同时把错误信息传递给订阅者。</p><p>三种信号的特点：</p><ul><li>错误信号和完成信号都是终止信号，不能共存</li><li>如果没有发送任何元素值，而是直接发送错误或者完成信号，表示是空数据流</li><li>如果没有错误信号，也没有完成信号，表示是无限数据流</li></ul><blockquote><p>引入依赖</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectreactor<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reactor-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>just 和 subscribe方法</p></blockquote><p>just()：创建Flux序列，并声明指定数据流</p><p>subscribe()：订阅Flux序列，只有进行订阅后才回触发数据流，不订阅就什么都不会发生</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestReactor</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="comment">//just()：创建Flux序列，并声明数据流，</span></span><br><span class="line">        Flux&lt;Integer&gt; integerFlux = Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>);<span class="comment">//整形</span></span><br><span class="line">        <span class="comment">//subscribe()：订阅Flux序列，只有进行订阅后才回触发数据流，不订阅就什么都不会发生</span></span><br><span class="line">        integerFlux.subscribe(System.out::println);</span><br><span class="line">        </span><br><span class="line">        Flux&lt;String&gt; stringFlux = Flux.just(<span class="string">"hello"</span>, <span class="string">"world"</span>);<span class="comment">//字符串</span></span><br><span class="line">        stringFlux.subscribe(System.out::println);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//fromArray(),fromIterable()和fromStream()：可以从一个数组、Iterable 对象或Stream 对象中创建Flux序列</span></span><br><span class="line">        Integer[] array = {<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>};</span><br><span class="line">        Flux.fromArray(array).subscribe(System.out::println);</span><br><span class="line">        </span><br><span class="line">        List&lt;Integer&gt; integers = Arrays.asList(array);</span><br><span class="line">        Flux.fromIterable(integers).subscribe(System.out::println);</span><br><span class="line">        </span><br><span class="line">        Stream&lt;Integer&gt; stream = integers.stream();</span><br><span class="line">        Flux.fromStream(stream).subscribe(System.out::println);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>启动测试：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/adca59c8d9e04ce58d3b9570cbc1bed4.png" alt="在这里插入图片描述"></p><h2 id="响应流的特点">响应流的特点</h2><p>要搞清楚这两个概念，必须说一下响应流规范。它是响应式编程的基石。他具有以下特点：</p><ul><li>响应流必须是无阻塞的。</li><li>响应流必须是一个数据流。</li><li>它必须可以异步执行。</li><li>并且它也应该能够处理背压。</li><li><strong>即时响应性:</strong> 只要有可能， <a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.reactivemanifesto.org/zh-CN/glossary#System">系统</a>就会及时地做出响应。 即时响应是可用性和实用性的基石， 而更加重要的是，即时响应意味着可以快速地检测到问题并且有效地对其进行处理。 即时响应的系统专注于提供快速而一致的响应时间， 确立可靠的反馈上限， 以提供一致的服务质量。 这种一致的行为转而将简化错误处理、 建立最终用户的信任并促使用户与系统作进一步的互动。</li><li>**回弹性：**系统在出现<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.reactivemanifesto.org/zh-CN/glossary#Failure">失败</a>时依然保持即时响应性。 这不仅适用于高可用的、 任务关键型系统——任何不具备回弹性的系统都将会在发生失败之后丢失即时响应性。 回弹性是通过<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.reactivemanifesto.org/zh-CN/glossary#Replication">复制</a>、 遏制、 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.reactivemanifesto.org/zh-CN/glossary#Isolation">隔离</a>以及<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.reactivemanifesto.org/zh-CN/glossary#Delegation">委托</a>来实现的。 失败的扩散被遏制在了每个<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.cnblogs.com/glossary.zh-cn.md#组件">组件</a>内部， 与其他组件相互隔离， 从而确保系统某部分的失败不会危及整个系统，并能独立恢复。 每个组件的恢复都被委托给了另一个（外部的）组件， 此外，在必要时可以通过复制来保证高可用性。 （因此）组件的客户端不再承担组件失败的处理。</li><li><strong>弹性：</strong> 系统在不断变化的工作负载之下依然保持即时响应性。 反应式系统可以对输入（负载）的速率变化做出反应，比如通过增加或者减少被分配用于服务这些输入（负载）的<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.reactivemanifesto.org/zh-CN/glossary#Resource">资源</a>。 这意味着设计上并没有争用点和中央瓶颈， 得以进行组件的分片或者复制， 并在它们之间分布输入（负载）。 通过提供相关的实时性能指标， 反应式系统能支持预测式以及反应式的伸缩算法。 这些系统可以在常规的硬件以及软件平台上实现成本高效的<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.reactivemanifesto.org/zh-CN/glossary#Elasticity">弹性</a><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.reactivemanifesto.org/zh-CN/glossary#Elasticity">。</a></li><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.reactivemanifesto.org/zh-CN/glossary#Elasticity">**消息驱动：**反应式系统依赖</a><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.reactivemanifesto.org/zh-CN/glossary#Asynchronous">异步的</a><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.reactivemanifesto.org/zh-CN/glossary#Message-Driven">消息传递</a>，从而确保了松耦合、隔离、<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.reactivemanifesto.org/zh-CN/glossary#Location-Transparency">位置透明</a>的组件之间有着明确边界。 这一边界还提供了将<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.reactivemanifesto.org/zh-CN/glossary#Failure">失败</a>作为消息委托出去的手段。 使用显式的消息传递，可以通过在系统中塑造并监视消息流队列， 并在必要时应用<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.reactivemanifesto.org/zh-CN/glossary#Back-Pressure">回压</a>， 从而实现负载管理、 弹性以及流量控制。 使用位置透明的消息传递作为通信的手段， 使得跨集群或者在单个主机中使用相同的结构成分和语义来管理失败成为了可能。 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.reactivemanifesto.org/zh-CN/glossary#Non-Blocking">非阻塞的</a>通信使得接收者可以只在活动时才消耗<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.reactivemanifesto.org/zh-CN/glossary#Resource">资源</a>， 从而减少系统开销。</li></ul><h2 id="publisherflux和mono">Publisher/Flux和Mono</h2><p>由于响应流的特点，我们不能再返回一个简单的<strong>POJO</strong>对象来表示结果了。必须返回一个类似<strong>Java</strong>中的<code>Future</code>的概念，在有结果可用时通知消费者进行消费响应。</p><p><strong>Reactive Stream</strong>规范中这种被定义为Publisher</p><p>Publisher是一个可以提供0-N个序列元素的提供者，并根据其订阅者<code>Subscriber&lt;? super T&gt;</code>的需求推送元素。</p><p>一个Publisher可以支持多个订阅者，并可以根据订阅者的逻辑进行推送序列元素。</p><p>下面这个<strong>Excel</strong>计算就能说明一些Publisher的特点。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/image-20241217163334529.png" alt="image-20241217163334529"></p><p><strong>A1-A9</strong>就可以看做Publisher及其提供的元素序列。</p><p><strong>A10-A13</strong>分别是求和函数<code>SUM(A1:A9)</code>、平均函数<code>AVERAGE(A1:A9)</code>、最大值函数<code>MAX(A1:A9)</code>、最小值函数<code>MIN(A1:A9)</code>，</p><p><strong>A10-A13</strong>可以看作订阅者<code>Subscriber</code>。</p><p>假如说我们没有<strong>A10-A13</strong>，那么<strong>A1-A9</strong>就没有实际意义，它们并不产生计算。</p><p>这也是响应式的一个重要特点：<strong>当没有订阅时发布者什么也不做</strong>。而Flux和Mono都是Publisher在<strong>Reactor 3</strong>实现。</p><p>Publisher提供了<code>subscribe</code>方法，允许消费者在有结果可用时进行消费。</p><p>如果没有消费者Publisher不会做任何事情，他根据消费情况进行响应。</p><p>Publisher可能返回零或者多个，甚至可能是无限的，为了更加清晰表示期待的结果就引入了两个实现模型Mono和Flux。</p><h3 id="flux">Flux</h3><p>Flux 是一个发出(emit)<code>0-N</code>个元素组成的异步序列的Publisher,可以被<code>onComplete</code>信号或者<code>onError</code>信号所终止。</p><p>在响应流规范中存在三种给下游消费者调用的方法 <code>onNext</code>, <code>onComplete</code>, 和<code>onError</code>。下面这张图表示了Flux的抽象模型：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/39057f0084064329a48d28a49d627dd0.png" alt="img"></p><p>以上的的讲解对于初次接触反应式编程的依然是难以理解的，所以这里有一个循序渐进的理解过程。</p><blockquote><p><strong>有些类比并不是很妥当，但是对于你循序渐进的理解这些新概念还是有帮助的。</strong></p></blockquote><h3 id="传统数据处理">传统数据处理</h3><p>我们在平常是这么写的：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;ClientUser&gt; <span class="title">allUsers</span>()</span> {</span><br><span class="line">    <span class="keyword">return</span> Arrays.asList(<span class="keyword">new</span> ClientUser(<span class="string">"felord.cn"</span>, <span class="string">"reactive"</span>),</span><br><span class="line">            <span class="keyword">new</span> ClientUser(<span class="string">"Felordcn"</span>, <span class="string">"Reactor"</span>));</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>我们通过迭代返回值<code>List</code>来<code>get</code>这些元素进行再处理（消费），不管有没有消费者， 菜品都会生产出来。</p><h5 id="流式数据处理">流式数据处理</h5><p>在<strong>Java 8</strong>中我们可以改写为流的表示：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Stream&lt;ClientUser&gt; <span class="title">allUsers</span>()</span> {</span><br><span class="line">    <span class="keyword">return</span>  Stream.of(<span class="keyword">new</span> ClientUser(<span class="string">"felord.cn"</span>, <span class="string">"reactive"</span>),</span><br><span class="line">            <span class="keyword">new</span> ClientUser(<span class="string">"Felordcn"</span>, <span class="string">"Reactor"</span>));</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h3 id="反应式数据处理">反应式数据处理</h3><p>在<strong>Reactor</strong>中我们又可以改写为Flux表示：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Flux&lt;ClientUser&gt; <span class="title">allUsers</span>()</span>{</span><br><span class="line">    <span class="keyword">return</span> Flux.just(<span class="keyword">new</span> ClientUser(<span class="string">"felord.cn"</span>, <span class="string">"reactive"</span>),</span><br><span class="line">            <span class="keyword">new</span> ClientUser(<span class="string">"Felordcn"</span>, <span class="string">"Reactor"</span>));</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>这时候食客来了，发生了订阅，厨师才开始做。</p><h3 id="flux-的创建demo">Flux 的创建Demo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Flux</span> <span class="variable">ints</span> <span class="operator">=</span> Flux.range(<span class="number">1</span>, <span class="number">4</span>);</span><br><span class="line"><span class="type">Flux</span> <span class="variable">seq1</span> <span class="operator">=</span> Flux.just(<span class="string">"bole1"</span>, <span class="string">"bole2"</span>, <span class="string">"bole3"</span>);</span><br><span class="line"><span class="type">List</span> <span class="variable">iterable</span> <span class="operator">=</span> Arrays.asList(<span class="string">"bole_01"</span>, <span class="string">"bole_02"</span>, <span class="string">"bole_03"</span>);</span><br><span class="line"><span class="type">Flux</span> <span class="variable">seq2</span> <span class="operator">=</span> Flux.fromIterable(iterable);</span><br><span class="line">seq2.subscribe(i -&gt; System.out.println(i));</span><br></pre></td></tr></table></figure><h3 id="mono">Mono</h3><p>Mono 是一个发出(emit)<code>0-1</code>个元素的Publisher,可以被<code>onComplete</code>信号或者<code>onError</code>信号所终止。</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/3e90551078964d84b3ecaa6326adac11.png" alt="img"></p><p>mono 整体和Flux差不多，只不过这里只会发出0-1个元素。也就是说不是有就是没有。</p><p>象Flux一样，我们来看看Mono的演化过程以帮助理解。</p><h4 id="传统数据处理-1">传统数据处理</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ClientUser <span class="title">currentUser</span> ()</span> {</span><br><span class="line">    <span class="keyword">return</span> isAuthenticated ? <span class="keyword">new</span> ClientUser(<span class="string">"felord.cn"</span>, <span class="string">"reactive"</span>) : <span class="literal">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>直接返回符合条件的对象或者null`。</p><h4 id="optional的处理方式">Optional的处理方式</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Optional&lt;ClientUser&gt; <span class="title">currentUser</span> ()</span> {</span><br><span class="line">    <span class="keyword">return</span> isAuthenticated ? Optional.of(<span class="keyword">new</span> ClientUser(<span class="string">"felord.cn"</span>, <span class="string">"reactive"</span>))</span><br><span class="line">            : Optional.empty();</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>这个Optional我觉得就有反应式的那种味儿了，当然它并不是反应式。当我们不从返回值Optional取其中具体的对象时，我们不清楚里面到底有没有，但是Optional是一定客观存在的,不会出现<strong>NPE</strong>问题。</p><h4 id="反应式数据处理-1">反应式数据处理</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;ClientUser&gt; <span class="title">currentUser</span> ()</span> {</span><br><span class="line">    <span class="keyword">return</span> isAuthenticated ? Mono.just(<span class="keyword">new</span> ClientUser(<span class="string">"felord.cn"</span>, <span class="string">"reactive"</span>))</span><br><span class="line">            : Mono.empty();</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>和Optional有点类似的机制，当然Mono不是为了解决<strong>NPE</strong>问题的，它是为了处理响应流中单个值（也可能是<code>Void</code>）而存在的。</p><h3 id="mono的创建demo">Mono的创建Demo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Mono</span> <span class="variable">data</span> <span class="operator">=</span> Mono.just(<span class="string">"bole"</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Mono</span> <span class="variable">noData</span> <span class="operator">=</span> Mono.empty();</span><br><span class="line"></span><br><span class="line">m.subscribe(i -&gt; System.out.println(i));</span><br></pre></td></tr></table></figure><h3 id="flux和mono总结">Flux和Mono总结</h3><p>Flux和Mono是<strong>Java</strong>反应式中的重要概念，但是很多同学包括我在开始都难以理解它们。这其实是规定了两种流式范式，这种范式让数据具有一些新的特性，比如基于发布订阅的事件驱动，异步流、背压等等。另外数据是推送（<strong>Push</strong>）给消费者的以区别于平时我们的拉（<strong>Pull</strong>）模式。同时我们可以像<a target="_blank" rel="noopener external nofollow noreferrer" href="https://links.jianshu.com/go?to=https%3A%2F%2Ffelord.cn%2Fjava8streamapi.html">Stream Api</a>一样使用类似`map`、<code>flatmap</code>等操作符（<strong>operator</strong>）来操作它们。</p><blockquote><p>说明：本文会以pdf格式持续更新，更多最新尼恩3高pdf笔记，请从下面的链接获取：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.yuque.com/crazymakercircle/gkkw8s/khigna">语雀</a> 或者 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://gitee.com/crazymaker/SimpleCrayIM/blob/master/疯狂创客圈总目录.md">码云</a></p></blockquote><h2 id="函数编程">函数编程</h2><p>反应式编程，常常和函数式编程结合，这就是让大家困扰的地方</p><h3 id="函数编程接口">函数编程接口</h3><table><thead><tr class="header"><th>接口函数名</th><th>说明</th></tr></thead><tbody><tr class="odd"><td>BiConsumer</td><td>表示接收两个输入参数和不返回结果的操作。</td></tr><tr class="even"><td>BiFunction</td><td>表示接受两个参数，并产生一个结果的函数。</td></tr><tr class="odd"><td>BinaryOperator</td><td>表示在相同类型的两个操作数的操作，生产相同类型的操作数的结果。</td></tr><tr class="even"><td>BiPredicate</td><td>代表两个参数谓词（布尔值函数）。</td></tr><tr class="odd"><td>BooleanSupplier</td><td>代表布尔值结果的提供者。</td></tr><tr class="even"><td>Consumer</td><td>表示接受一个输入参数和不返回结果的操作。</td></tr><tr class="odd"><td>DoubleBinaryOperator</td><td>代表在两个double值操作数的运算，并产生一个double值结果。</td></tr><tr class="even"><td>DoubleConsumer</td><td>表示接受一个double值参数，不返回结果的操作。</td></tr><tr class="odd"><td>DoubleFunction</td><td>表示接受double值参数，并产生一个结果的函数。</td></tr><tr class="even"><td>DoublePredicate</td><td>代表一个double值参数谓词（布尔值函数）。</td></tr><tr class="odd"><td>DoubleSupplier</td><td>表示表示接受double值参数，并产生一个结果的函数。值结果的提供者。</td></tr><tr class="even"><td>DoubleToIntFunction</td><td>表示接受一个double值参数，不返回结果的操作。</td></tr><tr class="odd"><td>DoubleFunction</td><td>表示接受double值参数，并产生一个结果的函数。</td></tr><tr class="even"><td>DoublePredicate</td><td>代表一个double值参数谓词（布尔值函数）。</td></tr><tr class="odd"><td>DoubleSupplier</td><td>DoubleToIntFunction</td></tr><tr class="even"><td>DoubleToIntFunction</td><td>表示接受double值参数，并产生一个int值结果的函数。</td></tr><tr class="odd"><td>DoubleToLongFunction</td><td>表示上产生一个double值结果的单个double值操作数的操作。</td></tr><tr class="even"><td>Function</td><td>代表接受一个double值参数，并产生一个long值结果的函数。</td></tr><tr class="odd"><td>DoubleUnaryOperator</td><td>表示上产生一个double值结果的单个double值操作数的操作。</td></tr><tr class="even"><td>Function</td><td>表示接受一个参数，并产生一个结果的函数。</td></tr><tr class="odd"><td>IntConsumer</td><td>表示接受单个int值的参数并没有返回结果的操作。</td></tr><tr class="even"><td>IntFunction</td><td>表示接受一个int值参数，并产生一个结果的函数。</td></tr><tr class="odd"><td>IntPredicate</td><td>表示一个整数值参数谓词（布尔值函数）。</td></tr><tr class="even"><td>IntSupplier</td><td>代表整型值的结果的提供者。</td></tr><tr class="odd"><td>IntToLongFunction</td><td>表示接受一个int值参数，并产生一个long值结果的函数。</td></tr><tr class="even"><td>IntUnaryOperator</td><td>表示产生一个int值结果的单个int值操作数的运算。</td></tr><tr class="odd"><td>LongBinaryOperator</td><td>表示在两个long值操作数的操作，并产生一个ObjLongConsumer值结果。</td></tr><tr class="even"><td>LongFunction</td><td>表示接受long值参数，并产生一个结果的函数。</td></tr><tr class="odd"><td>LongPredicate</td><td>代表一个long值参数谓词（布尔值函数）。</td></tr><tr class="even"><td>LongSupplier</td><td>表示long值结果的提供者。</td></tr><tr class="odd"><td>LongToDoubleFunction</td><td>表示接受double参数，并产生一个double值结果的函数。</td></tr><tr class="even"><td>LongToIntFunction</td><td>表示接受long值参数，并产生一个int值结果的函数。</td></tr><tr class="odd"><td>LongUnaryOperator</td><td>表示上产生一个long值结果单一的long值操作数的操作。</td></tr><tr class="even"><td>ObjDoubleConsumer</td><td>表示接受对象值和double值参数，并且没有返回结果的操作。</td></tr><tr class="odd"><td>ObjIntConsumer</td><td>表示接受对象值和整型值参数，并返回没有结果的操作。</td></tr><tr class="even"><td>ObjLongConsumer</td><td>表示接受对象值和整型值参数，并返回没有结果的操作。</td></tr><tr class="odd"><td>ObjLongConsumer</td><td>表示接受对象值和double值参数，并且没有返回结果的操作。</td></tr><tr class="even"><td>ObjIntConsumer</td><td>表示接受对象值和整型值参数，并返回没有结果的操作。</td></tr><tr class="odd"><td>ObjLongConsumer</td><td>表示接受对象的值和long值的说法，并没有返回结果的操作。</td></tr><tr class="even"><td>Predicate</td><td>代表一个参数谓词（布尔值函数）。</td></tr><tr class="odd"><td>Supplier</td><td>表示一个提供者的结果。</td></tr><tr class="even"><td>ToDoubleBiFunction</td><td>表示接受两个参数，并产生一个double值结果的功能。</td></tr><tr class="odd"><td>ToDoubleFunction</td><td>代表一个产生一个double值结果的功能。</td></tr><tr class="even"><td>ToIntBiFunction</td><td>表示接受两个参数，并产生一个int值结果的函数。</td></tr><tr class="odd"><td>ToIntFunction</td><td>代表产生一个int值结果的功能。</td></tr><tr class="even"><td>ToLongBiFunction</td><td>表示接受两个参数，并产生long值结果的功能。</td></tr><tr class="odd"><td>ToLongFunction</td><td>代表一个产生long值结果的功能。</td></tr><tr class="even"><td>UnaryOperator</td><td>表示上产生相同类型的操作数的结果的单个操作数的操作。</td></tr></tbody></table><h3 id="常用函数编程示例">常用函数编程示例</h3><p>Consumer 一个输入 无输出</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Product product=<span class="keyword">new</span> <span class="title class_">Product</span>();</span><br><span class="line"><span class="comment">//类名+静态方法  一个输入T 没有输出</span></span><br><span class="line"><span class="type">Consumer</span> <span class="variable">consumer1</span> <span class="operator">=</span> Product-&gt;Product.nameOf(product);<span class="comment">//lambda</span></span><br><span class="line">consumer1.accept(product);</span><br><span class="line"><span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> Product::nameOf;<span class="comment">//方法引用</span></span><br><span class="line">consumer.accept(product);</span><br></pre></td></tr></table></figure><p>Funtion&lt;T,R&gt; 一个输入 一个输出</p><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//对象+方法  一个输入T 一个输出R</span><br><span class="line"><span class="keyword">Function</span>&lt;<span class="built_in">Integer</span>, <span class="built_in">Integer</span>&gt; <span class="keyword">function</span> = product::reduceStock;</span><br><span class="line">System.<span class="keyword">out</span>.println(<span class="string">"剩余库存："</span> + <span class="keyword">function</span>.apply(<span class="number">10</span>));</span><br><span class="line">//带参数的构造函数</span><br><span class="line"><span class="keyword">Function</span>&lt;<span class="built_in">Integer</span>,Product&gt; function1=Product::<span class="keyword">new</span>;</span><br><span class="line">System.<span class="keyword">out</span>.println(<span class="string">"新对象:"</span> +function1.apply(<span class="number">200</span>));</span><br></pre></td></tr></table></figure><p>Predicate 一个输入T, 一个输出 Boolean</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Predicate 一个输入T 一个输出Boolean</span></span><br><span class="line">Predicate predicate= i -&gt; product.isEnough(i);<span class="comment">//lambda</span></span><br><span class="line">System.out.<span class="built_in">println</span>(<span class="string">"库存是否足够："</span>+predicate.test(<span class="number">100</span>));</span><br><span class="line">Predicate predicate1= product::isEnough;<span class="comment">//方法引用</span></span><br><span class="line">System.out.<span class="built_in">println</span>(<span class="string">"库存是否足够："</span>+predicate1.test(<span class="number">100</span>));</span><br></pre></td></tr></table></figure><p>UnaryOperator 一元操作符 输入输出都是T</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//一元操作符  输入和输出T</span></span><br><span class="line">UnaryOperator integerUnaryOperator =product::reduceStock;</span><br><span class="line">System.out.<span class="built_in">println</span>(<span class="string">"剩余库存："</span> + integerUnaryOperator.apply(<span class="number">20</span>));</span><br><span class="line">IntUnaryOperator intUnaryOperator = product::reduceStock;</span><br><span class="line">System.out.<span class="built_in">println</span>(<span class="string">"剩余库存："</span> + intUnaryOperator.applyAsInt(<span class="number">30</span>));</span><br></pre></td></tr></table></figure><p>Supplier 没有输入 只有输出</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//无参数构造函数</span></span><br><span class="line">Supplier supplier = Product::<span class="built_in">new</span>;</span><br><span class="line">System.out.<span class="built_in">println</span>(<span class="string">"创建新对象:"</span> + supplier.get());</span><br><span class="line">Supplier supplier1=()-&gt;product.getStock();</span><br><span class="line">System.out.<span class="built_in">println</span>(<span class="string">"剩余库存:"</span> + supplier1.get());</span><br></pre></td></tr></table></figure><p>BiFunction 二元操作符 两个输入&lt;T,U&gt; 一个输出</p><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//类名+方法</span><br><span class="line">BiFunction&lt;Product, <span class="built_in">Integer</span>, <span class="built_in">Integer</span>&gt; binaryOperator = Product::reduceStock;</span><br><span class="line">System.<span class="keyword">out</span>.println(<span class="string">" 剩余库存(BiFunction)："</span> + binaryOperator.apply(product, <span class="number">10</span>));</span><br></pre></td></tr></table></figure><p>BinaryOperator 二元操作符 ,二个输入 一个输出</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//BinaryOperator binaryOperator1=(x,y)-&gt;product.reduceStock(x,y);</span></span><br><span class="line">BinaryOperator binaryOperator1=product::reduceStock;</span><br><span class="line">System.out.<span class="built_in">println</span>(<span class="string">" 剩余库存(BinaryOperator)："</span> +binaryOperator<span class="number">1.</span><span class="built_in">apply</span>(product.<span class="built_in">getStock</span>(),<span class="number">10</span>));</span><br></pre></td></tr></table></figure><blockquote><p>说明：本文会以pdf格式持续更新，更多最新尼恩3高pdf笔记，请从下面的链接获取：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.yuque.com/crazymakercircle/gkkw8s/khigna">语雀</a> 或者 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://gitee.com/crazymaker/SimpleCrayIM/blob/master/疯狂创客圈总目录.md">码云</a></p></blockquote><h2 id="flux类中的静态方法">Flux类中的静态方法：</h2><h3 id="简单的创建方法">简单的创建方法</h3><p><strong>just</strong>()：</p><p>可以指定序列中包含的全部元素。创建出来的Flux序列在发布这些元素之后会自动结束</p><p><strong>fromArray()，fromIterable()，fromStream()：</strong></p><p>可以从一个数组，Iterable对象或Stream对象中穿件Flux对象</p><p><strong>empty</strong>()：</p><p>创建一个不包含任何元素，只发布结束消息的序列</p><p><strong>error</strong>(Throwable error)：</p><p>创建一个只包含错误消息的序列</p><p><strong>never</strong>()：</p><p>传建一个不包含任务消息通知的序列</p><p><strong>range(int start, int count)：</strong></p><p>创建包含从start起始的count个数量的Integer对象的序列</p><p><strong>interval(Duration period)和interval(Duration delay, Duration period)：</strong></p><p>创建一个包含了从0开始递增的Long对象的序列。其中包含的元素按照指定的间隔来发布。除了间隔时间之外，还可以指定起始元素发布之前的延迟时间</p><p><strong>intervalMillis(long period)和intervalMillis(long delay, long period)：</strong></p><p>与interval()方法相同，但该方法通过毫秒数来指定时间间隔和延迟时间</p><p>例子</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Flux<span class="selector-class">.just</span>("Hello", "World")<span class="selector-class">.subscribe</span>(System.out::println);</span><br><span class="line">Flux<span class="selector-class">.fromArray</span>(new Integer[]{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>})<span class="selector-class">.subscribe</span>(System.out::println);</span><br><span class="line">Flux<span class="selector-class">.empty</span>()<span class="selector-class">.subscribe</span>(System.out::println);</span><br><span class="line">Flux<span class="selector-class">.range</span>(<span class="number">1</span>, <span class="number">10</span>)<span class="selector-class">.subscribe</span>(System.out::println);</span><br><span class="line">Flux<span class="selector-class">.interval</span>(Duration.of(<span class="number">10</span>, ChronoUnit.SECONDS))<span class="selector-class">.subscribe</span>(System.out::println);</span><br><span class="line">Flux<span class="selector-class">.intervalMillis</span>(<span class="number">1000</span>)<span class="selector-class">.subscirbe</span>(System.out::println);</span><br></pre></td></tr></table></figure><h3 id="复杂的序列创建-generate">复杂的序列创建 generate()</h3><p>当序列的生成需要复杂的逻辑时，则应该使用generate()或create()方法。</p><p>generate()方法通过同步和逐一的方式来产生Flux序列。</p><p>序列的产生是通过调用所提供的的SynchronousSink对象的next()，complete()和error(Throwable)方法来完成的。</p><p>逐一生成的含义是在具体的生成逻辑中，next()方法只能最多被调用一次。</p><p>在某些情况下，序列的生成可能是有状态的，需要用到某些状态对象，此时可以使用</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">generate</span>(Callable&lt;S&gt; stateSupplier, BiFunction&lt;S, SynchronousSink&lt;T&gt;, S&gt; generator)，</span><br></pre></td></tr></table></figure><p>其中stateSupplier用来提供初始的状态对象。</p><p>在进行序列生成时，状态对象会作为generator使用的第一个参数传入，可以在对应的逻辑中对改状态对象进行修改以供下一次生成时使用。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Flux.<span class="title function_ invoke__">generate</span>(sink -&gt; {</span><br><span class="line">  sink.<span class="title function_ invoke__">next</span>(<span class="string">"Hello"</span>);</span><br><span class="line">  sink.<span class="title function_ invoke__">complete</span>();  </span><br><span class="line">}).<span class="title function_ invoke__">subscribe</span>(System.out::<span class="variable constant_">println</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Random random = <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">Flux.<span class="title function_ invoke__">generate</span>(<span class="title class_">ArrayList</span>::<span class="variable constant_">new</span>, (<span class="keyword">list</span>, sink) -&gt; {</span><br><span class="line">  <span class="keyword">int</span> value = random.<span class="title function_ invoke__">nextInt</span>(<span class="number">100</span>);</span><br><span class="line">  <span class="keyword">list</span>.<span class="title function_ invoke__">add</span>(value);</span><br><span class="line">  sink.<span class="title function_ invoke__">next</span>(value);</span><br><span class="line">  <span class="keyword">if</span>( <span class="keyword">list</span>.<span class="title function_ invoke__">size</span>() ==<span class="number">10</span> )</span><br><span class="line">    sink.<span class="title function_ invoke__">complete</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">list</span>;</span><br><span class="line">}).<span class="title function_ invoke__">subscribe</span>(System.out::<span class="variable constant_">println</span>);</span><br></pre></td></tr></table></figure><h3 id="复杂的序列创建-create">复杂的序列创建 create()</h3><p>create()方法与generate()方法的不同之处在于所使用的是FluxSink对象。</p><p>FluxSink支持同步和异步的消息产生，并且可以在一次调用中产生多个元素。</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Flux<span class="selector-class">.create</span>(sink -&gt; {</span><br><span class="line">  for(int i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i ++)</span><br><span class="line">    sink<span class="selector-class">.next</span>(i);</span><br><span class="line">  sink<span class="selector-class">.complete</span>();</span><br><span class="line">})<span class="selector-class">.subscribe</span>(System.out::println);</span><br></pre></td></tr></table></figure><h2 id="mono静态方法">Mono静态方法</h2><p>Mono类包含了与Flux类中相同的静态方法：just()，empty()和never()等。</p><p>除此之外，Mono还有一些独有的静态方法：</p><ul><li>fromCallable()，fromCompletionStage()，fromFuture()，fromRunnable()和fromSupplier()：分别从Callable，CompletionStage，CompletableFuture，Runnable和Supplier中创建Mono</li><li>delay(Duration duration)和delayMillis(long duration)：创建一个Mono序列，在指定的延迟时间之后，产生数字0作为唯一值</li><li>ignoreElements(Publisher source)：创建一个Mono序列，忽略作为源的Publisher中的所有元素，只产生消息</li><li>justOrEmpty(Optional&lt;? extends T&gt; data)和justOrEmpty(T data)：从一个Optional对象或可能为null的对象中创建Mono。只有Optional对象中包含之或对象不为null时，Mono序列才产生对应的元素</li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Mono.<span class="title function_ invoke__">fromSupplier</span>(() <span class="punctuation">-&gt;</span> <span class="string">"Hello"</span>).<span class="title function_ invoke__">subscribe</span>(System.out::println);</span><br><span class="line">Mono.<span class="title function_ invoke__">justOrEmpty</span>(Optional.<span class="title function_ invoke__">of</span>(<span class="string">"Hello"</span>)).<span class="title function_ invoke__">subscribe</span>(System.out::println);</span><br><span class="line">Mono.<span class="title function_ invoke__">create</span>(sink <span class="punctuation">-&gt;</span> sink.<span class="title function_ invoke__">success</span>(<span class="string">"Hello"</span>)).<span class="title function_ invoke__">subscribte</span>(System.out::println);</span><br></pre></td></tr></table></figure><blockquote><p>说明：本文会以pdf格式持续更新，更多最新尼恩3高pdf笔记，请从下面的链接获取：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.yuque.com/crazymakercircle/gkkw8s/khigna">语雀</a> 或者 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://gitee.com/crazymaker/SimpleCrayIM/blob/master/疯狂创客圈总目录.md">码云</a></p></blockquote><h2 id="操作符">操作符</h2><h3 id="操作符buffer和buffertimeout">操作符buffer和bufferTimeout</h3><p>这两个操作符的作用是把当前流中的元素收集到集合中，并把集合对象作为流中的新元素。</p><p>在进行收集时可以指定不同的条件：所包含的元素的最大数量或收集的时间间隔。方法buffer()仅使用一个条件，而bufferTimeout()可以同时指定两个条件。</p><p>指定时间间隔时可以使用Duration对象或毫秒数，即使用bufferMillis()或bufferTimeoutMillis()两个方法。</p><p>除了元素数量和时间间隔外，还可以通过bufferUntil和bufferWhile操作符来进行收集。这两个操作符的参数时表示每个集合中的元素索要满足的条件的Predicate对象。</p><p>bufferUntil会一直收集直到Predicate返回true。</p><p>使得Predicate返回true的那个元素可以选择添加到当前集合或下一个集合中；bufferWhile则只有当Predicate返回true时才会收集。一旦为false，会立即开始下一次收集。</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Flux<span class="selector-class">.range</span>(<span class="number">1</span>, <span class="number">100</span>)<span class="selector-class">.buffer</span>(<span class="number">20</span>)<span class="selector-class">.subscribe</span>(System.out::println);</span><br><span class="line">Flux<span class="selector-class">.intervalMillis</span>(<span class="number">100</span>)<span class="selector-class">.bufferMillis</span>(<span class="number">1001</span>)<span class="selector-class">.take</span>(<span class="number">2</span>)<span class="selector-class">.toStream</span>()<span class="selector-class">.forEach</span>(System.out::println);</span><br><span class="line">Flux<span class="selector-class">.range</span>(<span class="number">1</span>, <span class="number">10</span>)<span class="selector-class">.bufferUntil</span>(i -&gt; i%<span class="number">2</span> == <span class="number">0</span>)<span class="selector-class">.subscribe</span>(System.out::println);</span><br><span class="line">Flux<span class="selector-class">.range</span>(<span class="number">1</span>, <span class="number">10</span>)<span class="selector-class">.bufferWhile</span>(i -&gt; i%<span class="number">2</span> == <span class="number">0</span>)<span class="selector-class">.subscribe</span>(System.out::println);</span><br></pre></td></tr></table></figure><h3 id="操作符filter">操作符Filter</h3><p>对流中包含的元素进行过滤，只留下满足Predicate指定条件的元素。</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Flux<span class="selector-class">.range</span>(<span class="number">1</span>, <span class="number">10</span>)<span class="selector-class">.filter</span>(i -&gt; i%<span class="number">2</span> == <span class="number">0</span>)<span class="selector-class">.subscribe</span>(System.out::println);</span><br></pre></td></tr></table></figure><h3 id="操作符zipwith">操作符zipWith</h3><p>zipWith操作符把当前流中的元素与另一个流中的元素按照一对一的方式进行合并。在合并时可以不做任何处理，由此得到的是一个元素类型为Tuple2的流；也可以通过一个BiFunction函数对合并的元素进行处理，所得到的流的元素类型为该函数的返回值。</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Flux.<span class="keyword">just("a", </span><span class="string">"b"</span>).zipWith(Flux.<span class="keyword">just("c", </span><span class="string">"d"</span>)).<span class="keyword">subscribe(System.out::println);</span></span><br><span class="line"><span class="keyword"></span>Flux.<span class="keyword">just("a", </span><span class="string">"b"</span>).zipWith(Flux.<span class="keyword">just("c", </span><span class="string">"d"</span>), (<span class="built_in">s1</span>, <span class="built_in">s2</span>) -&gt; String.format(<span class="string">"%s-%s"</span>, <span class="built_in">s1</span>, <span class="built_in">s2</span>)).<span class="keyword">subscribe(System.out::println);</span></span><br></pre></td></tr></table></figure><h3 id="操作符take">操作符take</h3><p>take系列操作符用来从当前流中提取元素。提取方式如下：</p><ul><li><p>take(long n)，take(Duration timespan)和takeMillis(long timespan)：按照指定的数量或时间间隔来提取</p></li><li><p>takeLast(long n)：提取流中的最后N个元素</p></li><li><p>takeUntil(Predicate&lt;? super T&gt; predicate) ：提取元素直到Predicate返回true</p></li><li><p>takeWhile(Predicate&lt;? super T&gt; continuePredicate)：当Predicate返回true时才进行提取</p></li><li><p>takeUntilOther(Publisher&lt;?&gt; other)：提取元素知道另外一个流开始产生元素</p></li></ul><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Flux<span class="selector-class">.range</span>(<span class="number">1</span>, <span class="number">1000</span>)<span class="selector-class">.take</span>(<span class="number">10</span>)<span class="selector-class">.subscribe</span>(System.out::println);</span><br><span class="line">Flux<span class="selector-class">.range</span>(<span class="number">1</span>, <span class="number">1000</span>)<span class="selector-class">.takeLast</span>(<span class="number">10</span>)<span class="selector-class">.subscribe</span>(System.out::println);</span><br><span class="line">Flux<span class="selector-class">.range</span>(<span class="number">1</span>, <span class="number">1000</span>)<span class="selector-class">.takeWhile</span>(i -&gt; i &lt; <span class="number">10</span>)<span class="selector-class">.subscribe</span>(System.out::println);</span><br><span class="line">Flux<span class="selector-class">.range</span>(<span class="number">1</span>, <span class="number">1000</span>)<span class="selector-class">.takeUntil</span>(i -&gt; i == <span class="number">10</span>)<span class="selector-class">.subscribe</span>(System.out::println);</span><br></pre></td></tr></table></figure><h3 id="操作符reduce和reducewith">操作符reduce和reduceWith</h3><p>reduce和reduceWith操作符对流中包含的所有元素进行累计操作，得到一个包含计算结果的Mono序列。累计操作是通过一个BiFunction来表示的。在操作时可以指定一个初始值。若没有初始值，则序列的第一个元素作为初始值。</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Flux<span class="selector-class">.range</span>(<span class="number">1</span>, <span class="number">100</span>)<span class="selector-class">.reduce</span>((x, y) -&gt; <span class="attribute">x</span> + <span class="attribute">y</span>)<span class="selector-class">.subscribe</span>(System.out::println);</span><br><span class="line">Flux<span class="selector-class">.range</span>(<span class="number">1</span>, <span class="number">100</span>)<span class="selector-class">.reduceWith</span>(() -&gt; <span class="number">100</span>, (x + y) -&gt; <span class="attribute">x</span> + <span class="attribute">y</span>)<span class="selector-class">.subscribe</span>(System.out::println);</span><br></pre></td></tr></table></figure><h3 id="操作符merge和mergesequential">操作符merge和mergeSequential</h3><p>merge和mergeSequential操作符用来把多个流合并成一个Flux序列。merge按照所有流中元素的实际产生序列来合并，而mergeSequential按照所有流被订阅的顺序，以流为单位进行合并。</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Flux<span class="selector-class">.merge</span>(Flux.intervalMillis(<span class="number">0</span>, <span class="number">100</span>)<span class="selector-class">.take</span>(<span class="number">5</span>), Flux<span class="selector-class">.intervalMillis</span>(<span class="number">50</span>, <span class="number">100</span>)<span class="selector-class">.take</span>(<span class="number">5</span>))<span class="selector-class">.toStream</span>()<span class="selector-class">.forEach</span>(System.out::println);</span><br><span class="line">Flux<span class="selector-class">.mergeSequential</span>(Flux.intervalMillis(<span class="number">0</span>, <span class="number">100</span>)<span class="selector-class">.take</span>(<span class="number">5</span>), Flux<span class="selector-class">.intervalMillis</span>(<span class="number">50</span>, <span class="number">100</span>)<span class="selector-class">.take</span>(<span class="number">5</span>))<span class="selector-class">.toStream</span>()<span class="selector-class">.forEach</span>(System.out::println);</span><br></pre></td></tr></table></figure><h3 id="操作符flatmap和flatmapsequential">操作符flatMap和flatMapSequential</h3><p>flatMap和flatMapSequential操作符把流中的每个元素转换成一个流，再把所有流中的元素进行合并。flatMapSequential和flatMap之间的区别与mergeSequential和merge是一样的。</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Flux<span class="selector-class">.just</span>(<span class="number">5</span>, <span class="number">10</span>)<span class="selector-class">.flatMap</span>(x -&gt; Flux.intervalMillis(x * <span class="number">10</span>, <span class="number">100</span>)<span class="selector-class">.take</span>(x))<span class="selector-class">.toStream</span>()<span class="selector-class">.forEach</span>(System.out::println);</span><br></pre></td></tr></table></figure><h3 id="操作符concatmap">操作符concatMap</h3><p>concatMap操作符的作用也是把流中的每个元素转换成一个流，再把所有流进行合并。concatMap会根据原始流中的元素顺序依次把转换之后的流进行合并，并且concatMap堆转换之后的流的订阅是动态进行的，而flatMapSequential在合并之前就已经订阅了所有的流。</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Flux<span class="selector-class">.just</span>(<span class="number">5</span>, <span class="number">10</span>)<span class="selector-class">.concatMap</span>(x -&gt; Flux.intervalMillis(x * <span class="number">10</span>, <span class="number">100</span>)<span class="selector-class">.take</span>(x))<span class="selector-class">.toStream</span>()<span class="selector-class">.forEach</span>(System.out::println);</span><br></pre></td></tr></table></figure><h3 id="操作符combinelatest">操作符combineLatest</h3><p>combineLatest操作符把所有流中的最新产生的元素合并成一个新的元素，作为返回结果流中的元素。只要其中任何一个流中产生了新的元素，合并操作就会被执行一次，结果流中就会产生新的元素。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Flux<span class="selector-class">.combineLatest</span>(Arrays::toString, Flux.<span class="built_in">intervalMillis</span>(<span class="number">100</span>).<span class="built_in">take</span>(<span class="number">5</span>), Flux.<span class="built_in">intervalMillis</span>(<span class="number">50</span>, <span class="number">100</span>).<span class="built_in">take</span>(<span class="number">5</span>)).<span class="built_in">toStream</span>().<span class="built_in">forEach</span>(System.out::println);</span><br></pre></td></tr></table></figure><h2 id="消息处理">消息处理</h2><p>当需要处理Flux或Mono中的消息时，可以通过subscribe方法来添加相应的订阅逻辑。</p><p>在调用subscribe方法时可以指定需要处理的消息类型。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">1</span>, <span class="number">2</span>).concatWith(Mono.<span class="type">error</span>(<span class="built_in">new</span> IllegalStateException())).subscribe(System.out::<span class="built_in">println</span>, System.err::<span class="built_in">println</span>);</span><br><span class="line"></span><br><span class="line">Flux.just(<span class="number">1</span>, <span class="number">2</span>).concatWith(Mono.<span class="type">error</span>(<span class="built_in">new</span> IllegalStateException())).onErrorReturn(<span class="number">0</span>).subscribe(System.out::<span class="built_in">println</span>);</span><br></pre></td></tr></table></figure><p>第2种可以通过switchOnError()方法来使用另外的流来产生元素。</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Flux<span class="selector-class">.just</span>(<span class="number">1</span>, <span class="number">2</span>)<span class="selector-class">.concatWith</span>(Mono.error(new IllegalStateException()))<span class="selector-class">.switchOnError</span>(Mono.just(<span class="number">0</span>))<span class="selector-class">.subscribe</span>(System.out::println);</span><br></pre></td></tr></table></figure><p>第3种是通过onErrorResumeWith()方法来根据不同的异常类型来选择要使用的产生元素的流。</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Flux<span class="selector-class">.just</span>(<span class="number">1</span>, <span class="number">2</span>)<span class="selector-class">.concatWith</span>(Mono.error(new IllegalArgumentException()))<span class="selector-class">.onErrorResumeWith</span>(e -&gt; {</span><br><span class="line">  if(e instanceof IllegalStateException)</span><br><span class="line">    return Mono<span class="selector-class">.just</span>(<span class="number">0</span>);</span><br><span class="line">  else <span class="built_in">if</span>(e instanceof IllegalArgumentException)</span><br><span class="line">    return Mono<span class="selector-class">.just</span>(-<span class="number">1</span>);</span><br><span class="line">  return Mono<span class="selector-class">.epmty</span>();</span><br><span class="line">})<span class="selector-class">.subscribe</span>(System,.out::println);</span><br></pre></td></tr></table></figure><p>当出现错误时还可以使用retry操作符来进行重试。重试的动作是通过重新订阅序列来实现的。在使用retry操作时还可以指定重试的次数。</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Flux<span class="selector-class">.just</span>(<span class="number">1</span>, <span class="number">2</span>)<span class="selector-class">.concatWith</span>(Mono.error(new IllegalStateException()))<span class="selector-class">.retry</span>(<span class="number">1</span>)<span class="selector-class">.subscrible</span>(System.out::println);</span><br></pre></td></tr></table></figure><blockquote><p>说明：本文会以pdf格式持续更新，更多最新尼恩3高pdf笔记，请从下面的链接获取：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.yuque.com/crazymakercircle/gkkw8s/khigna">语雀</a> 或者 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://gitee.com/crazymaker/SimpleCrayIM/blob/master/疯狂创客圈总目录.md">码云</a></p></blockquote><h2 id="调度器scheduler">调度器Scheduler</h2><p>通过调度器可以指定操作执行的方式和所在的线程。有以下几种不同的调度器实现</p><ul><li><p>当前线程，通过Schedulers.immediate()方法来创建</p></li><li><p>单一的可复用的线程，通过Schedulers.single()方法来创建</p></li><li><p>使用弹性的线程池，通过Schedulers.elastic()方法来创建。线程池中的线程是可以复用的。当所需要时，新的线程会被创建。若一个线程闲置时间太长，则会被销毁。该调度器适用于I/O操作相关的流的处理</p></li><li><p>使用对并行操作优化的线程池，通过Schedulers.parallel()方法来创建。其中的线程数量取决于CPU的核的数量。该调度器适用于计算密集型的流的处理</p></li><li><p>使用支持任务调度的调度器，通过Schedulers.timer()方法来创建</p></li><li><p>从已有的ExecutorService对象中创建调度器，通过Schedulers.fromExecutorService()方法来创建</p></li></ul><p>通过publishOn()和subscribeOn()方法可以切换执行操作调度器。publishOn()方法切换的是操作符的执行方式，而subscribeOn()方法切换的是产生流中元素时的执行方式</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Flux<span class="selector-class">.create</span>(sink -&gt; {</span><br><span class="line">  sink.next(Thread.currentThread()<span class="selector-class">.getName</span>());</span><br><span class="line">  sink<span class="selector-class">.complete</span>();  </span><br><span class="line">})<span class="selector-class">.publishOn</span>(Schedulers.single())</span><br><span class="line"><span class="selector-class">.map</span>(x -&gt;  String.format("[%s] %s", Thread.currentThread()<span class="selector-class">.getName</span>(), <span class="attribute">x</span>))</span><br><span class="line"><span class="selector-class">.publishOn</span>(Schedulers.elastic())</span><br><span class="line"><span class="selector-class">.map</span>(x -&gt; String.format("[%s] %s", Thread.currentThread()<span class="selector-class">.getName</span>(), <span class="attribute">x</span>))</span><br><span class="line"><span class="selector-class">.subscribeOn</span>(Schedulers.parallel())</span><br><span class="line"><span class="selector-class">.toStream</span>()</span><br><span class="line"><span class="selector-class">.forEach</span>(System.out::println);</span><br></pre></td></tr></table></figure><h2 id="测试">测试</h2><p>StepVerifier的作用是可以对序列中包含的元素进行逐一验证。通过StepVerifier.create()方法对一个流进行包装之后再进行验证。expectNext()方法用来声明测试时所期待的流中的下一个元素的值，而verifyComplete()方法则验证流是否正常结束。verifyError()来验证流由于错误而终止。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StepVerifier<span class="selector-class">.create</span>(Flux<span class="selector-class">.just</span>(<span class="selector-tag">a</span>, <span class="selector-tag">b</span>))<span class="selector-class">.expectNext</span>("<span class="selector-tag">a</span>")<span class="selector-class">.expectNext</span>("<span class="selector-tag">b</span>")<span class="selector-class">.verifyComplete</span>();</span><br></pre></td></tr></table></figure><p>使用StepVerifier.withVirtualTime()方法可以创建出使用虚拟时钟的SteoVerifier。通过thenAwait(Duration)方法可以让虚拟时钟前进。</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">StepVerifier<span class="selector-class">.withVirtualTime</span>(() -&gt; Flux<span class="selector-class">.interval</span>(Duration.ofHours(<span class="number">4</span>), Duration<span class="selector-class">.ofDays</span>(<span class="number">1</span>))<span class="selector-class">.take</span>(<span class="number">2</span>))</span><br><span class="line">　<span class="selector-class">.expectSubscription</span>()</span><br><span class="line">　<span class="selector-class">.expectNoEvent</span>(Duration.ofHours(<span class="number">4</span>))</span><br><span class="line">　<span class="selector-class">.expectNext</span>(<span class="number">0</span>L)</span><br><span class="line">　<span class="selector-class">.thenAwait</span>(Duration.ofDays(<span class="number">1</span>))</span><br><span class="line">　<span class="selector-class">.expectNext</span>(<span class="number">1</span>L)</span><br><span class="line">　<span class="selector-class">.verifyComplete</span>();</span><br></pre></td></tr></table></figure><p>TestPublisher的作用在于可以控制流中元素的产生，甚至是违反反应流规范的情况。通过create()方法创建一个新的TestPublisher对象，然后使用next()方法来产生元素，使用complete()方法来结束流。</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">final TestPublisher&lt;String&gt; testPublisher = TestPublisher.creater();</span><br><span class="line">testPublisher.<span class="built_in">next</span>(<span class="string">"a"</span>);</span><br><span class="line">testPublisher.<span class="built_in">next</span>(<span class="string">"b"</span>);</span><br><span class="line">testPublisher.complete();</span><br><span class="line"></span><br><span class="line">StepVerifier.<span class="built_in">create</span>(testPublisher)</span><br><span class="line">    .expectNext(<span class="string">"a"</span>)</span><br><span class="line">    .expectNext(<span class="string">"b"</span>)</span><br><span class="line">    .expectComplete();</span><br></pre></td></tr></table></figure><h2 id="调试">调试</h2><p>在调试模式启用之后，所有的操作符在执行时都会保存额外的与执行链相关的信息。当出现错误时，这些信息会被作为异常堆栈信息的一部分输出。</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hooks.<span class="title function_ invoke__">onOperator</span>(providedHook <span class="punctuation">-&gt;</span> providedHook.<span class="title function_ invoke__">operatorStacktrace</span>());</span><br></pre></td></tr></table></figure><p>也可以通过checkpoint操作符来对特定的流处理链来启用调试模式。</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Flux<span class="selector-class">.just</span>(<span class="number">1</span>, <span class="number">0</span>)<span class="selector-class">.map</span>(x -&gt; <span class="number">1</span>/x)<span class="selector-class">.checkpoint</span>("test")<span class="selector-class">.subscribe</span>(System.out::println);</span><br></pre></td></tr></table></figure><h2 id="日志记录">日志记录</h2><p>可以通过添加log操作把流相关的事件记录在日志中，</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Flux.<span class="keyword">range</span>(<span class="number">1</span>, <span class="number">2</span>).log(<span class="string">"Range"</span>).subscribe(System.out::<span class="built_in">println</span>);</span><br></pre></td></tr></table></figure><h2 id="冷热序列">冷热序列</h2><p>冷序列的含义是不论订阅者在何时订阅该序列，总是能收到序列中产生的全部消息。热序列是在持续不断的产生消息，订阅者只能获取到在其订阅之后产生的消息。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Flux&lt;<span class="built_in">Long</span>&gt; source = Flux.intervalMillis(<span class="number">1000</span>).take(<span class="number">10</span>).publish.autoConnect();</span><br><span class="line">source.subscribe();</span><br><span class="line">Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">source.toStream().forEach(System.<span class="keyword">out</span>::println);</span><br></pre></td></tr></table></figure><blockquote><p>说明：本文会以pdf格式持续更新，更多最新尼恩3高pdf笔记，请从下面的链接获取：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.yuque.com/crazymakercircle/gkkw8s/khigna">语雀</a> 或者 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://gitee.com/crazymaker/SimpleCrayIM/blob/master/疯狂创客圈总目录.md">码云</a></p></blockquote><h2 id="serverwebexchange交换机">ServerWebExchange交换机</h2><h3 id="serverwebexchange与过滤器的关系"><code>ServerWebExchange</code>与过滤器的关系：</h3><p>Spring Cloud Gateway同zuul类似，有“pre”和“post”两种方式的filter。</p><p>客户端的请求先经过“pre”类型的filter，然后将请求转发到具体的业务服务，收到业务服务的响应之后，再经过“post”类型的filter处理，最后返回响应到客户端。</p><p>引用Spring Cloud Gateway官网上的一张图： <a target="_blank" rel="noopener external nofollow noreferrer" href="https://user-images.githubusercontent.com/13992911/131647702-23c2f0c9-cca2-4ebb-b08c-5469d44b1434.png"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/2d635bf4a46b1657d8bb15fc3a178e88.png" alt="image"></a></p><p>与zuul不同的是，filter除了分为“pre”和“post”两种方式的filter外，在Spring Cloud Gateway中，filter从作用范围可分为另外两种，</p><p>一种是<strong>针对于单个路由的gateway filter</strong>，它在配置文件中的写法同predict类似；</p><p>一种是<strong>针对于所有路由的global gateway filer</strong>。</p><p>现在从作用范围划分的维度来讲解这两种filter。</p><p>我们在使用<code>Spring Cloud Gateway</code>的时候，注意到过滤器（包括<code>GatewayFilter</code>、<code>GlobalFilter</code>和过滤器链<code>GatewayFilterChain</code>）。</p><p>Spring Cloud Gateway根据作用范围划分为GatewayFilter和GlobalFilter，二者区别如下：</p><ul><li><strong>GatewayFilter</strong> : 需要通过spring.cloud.routes.filters 配置在具体路由下，只作用在当前路由上或通过spring.cloud.default-filters配置在全局，作用在所有路由上</li><li><strong>GlobalFilter</strong> : 全局过滤器，不需要在配置文件中配置，作用在所有的路由上，最终通过GatewayFilterAdapter包装成GatewayFilterChain可识别的过滤器，它为请求业务以及路由的URI转换为真实业务服务的请求地址的核心过滤器，不需要配置，系统初始化时加载，并作用在每个路由上。</li></ul><p>Spring Cloud Gateway框架内置的GlobalFilter如下：</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/dca13dad83c3ab4c45d433ed66699d1c.png" alt="img"></p><p>上图中每一个GlobalFilter都作用在每一个router上，能够满足大多数的需求。</p><p>但是如果遇到业务上的定制，可能需要编写满足自己需求的GlobalFilter。</p><p>过滤器都依赖到<code>ServerWebExchange</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GlobalFilter</span> {</span><br><span class="line"></span><br><span class="line">    Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GatewayFilter</span> <span class="keyword">extends</span> <span class="title class_">ShortcutConfigurable</span> {</span><br><span class="line"></span><br><span class="line">	Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GatewayFilterChain</span> {</span><br><span class="line"></span><br><span class="line">    Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange)</span>;</span><br><span class="line">}    </span><br></pre></td></tr></table></figure><p>这里的设计和<code>Servlet</code>中的<code>Filter</code>是相似的，</p><p>当前过滤器可以决定是否执行下一个过滤器的逻辑，由<code>GatewayFilterChain#filter()</code>是否被调用来决定。</p><p>而<code>ServerWebExchange</code>就相当于当前请求和响应的上下文。</p><p><code>ServerWebExchange</code>实例不单存储了<code>Request</code>和<code>Response</code>对象，还提供了一些扩展方法，如果想实现改造请求参数或者响应参数，就必须深入了解<code>ServerWebExchange</code>。</p><h3 id="理解serverwebexchange">理解ServerWebExchange</h3><p>先看<code>ServerWebExchange</code>的注释：</p><blockquote><p>Contract for an HTTP request-response interaction.</p><p>Provides access to the HTTP request and response and also exposes additional server-side processing related properties and features such as request attributes.</p></blockquote><p>翻译一下大概是：</p><blockquote><p>ServerWebExchange是一个HTTP请求-响应交互的契约。提供对HTTP请求和响应的访问，并公开额外的服务器端处理相关属性和特性，如请求属性。</p></blockquote><p>其实，<code>ServerWebExchange</code>命名为<strong>服务网络交换器</strong>，存放着重要的请求-响应属性、请求实例和响应实例等等，有点像<code>Context</code>的角色。</p><h3 id="serverwebexchange接口">ServerWebExchange接口</h3><p><code>ServerWebExchange</code>接口的所有方法：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">public interface <span class="title class_">ServerWebExchange</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 日志前缀属性的KEY，值为org.springframework.web.server.ServerWebExchange.LOG_ID</span></span><br><span class="line">    <span class="comment">// 可以理解为 attributes.set("org.springframework.web.server.ServerWebExchange.LOG_ID","日志前缀的具体值");</span></span><br><span class="line">    <span class="comment">// 作用是打印日志的时候会拼接这个KEY对饮的前缀值，默认值为""</span></span><br><span class="line">    <span class="title class_">String</span> <span class="variable constant_">LOG_ID_ATTRIBUTE</span> = <span class="title class_">ServerWebExchange</span>.<span class="property">class</span>.<span class="title function_">getName</span>() + <span class="string">".LOG_ID"</span>;</span><br><span class="line">    <span class="title class_">String</span> <span class="title function_">getLogPrefix</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取ServerHttpRequest对象</span></span><br><span class="line">    <span class="title class_">ServerHttpRequest</span> <span class="title function_">getRequest</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取ServerHttpResponse对象</span></span><br><span class="line">    <span class="title class_">ServerHttpResponse</span> <span class="title function_">getResponse</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 返回当前exchange的请求属性，返回结果是一个可变的Map</span></span><br><span class="line">    <span class="title class_">Map</span>&lt;<span class="title class_">String</span>, <span class="title class_">Object</span>&gt; <span class="title function_">getAttributes</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据KEY获取请求属性</span></span><br><span class="line">    @<span class="title class_">Nullable</span></span><br><span class="line">    <span class="keyword">default</span> &lt;T&gt; T <span class="title function_">getAttribute</span>(<span class="params"><span class="built_in">String</span> name</span>) {</span><br><span class="line">        <span class="keyword">return</span> (T) <span class="title function_">getAttributes</span>().<span class="title function_">get</span>(name);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据KEY获取请求属性，做了非空判断</span></span><br><span class="line">    @<span class="title class_">SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="keyword">default</span> &lt;T&gt; T <span class="title function_">getRequiredAttribute</span>(<span class="params"><span class="built_in">String</span> name</span>) {</span><br><span class="line">        T value = <span class="title function_">getAttribute</span>(name);</span><br><span class="line">        <span class="title class_">Assert</span>.<span class="title function_">notNull</span>(value, () -&gt; <span class="string">"Required attribute '"</span> + name + <span class="string">"' is missing"</span>);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 根据KEY获取请求属性，需要提供默认值</span></span><br><span class="line">    @<span class="title class_">SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="keyword">default</span> &lt;T&gt; T <span class="title function_">getAttributeOrDefault</span>(<span class="params"><span class="built_in">String</span> name, T defaultValue</span>) {</span><br><span class="line">        <span class="keyword">return</span> (T) <span class="title function_">getAttributes</span>().<span class="title function_">getOrDefault</span>(name, defaultValue);</span><br><span class="line">    } </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回当前请求的网络会话</span></span><br><span class="line">    <span class="title class_">Mono</span>&lt;<span class="title class_">WebSession</span>&gt; <span class="title function_">getSession</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回当前请求的认证用户，如果存在的话</span></span><br><span class="line">    &lt;T <span class="keyword">extends</span> <span class="title class_">Principal</span>&gt; <span class="title class_">Mono</span>&lt;T&gt; <span class="title function_">getPrincipal</span>();  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 返回请求的表单数据或者一个空的Map，只有Content-Type为application/x-www-form-urlencoded的时候这个方法才会返回一个非空的Map -- 这个一般是表单数据提交用到</span></span><br><span class="line">    <span class="title class_">Mono</span>&lt;<span class="title class_">MultiValueMap</span>&lt;<span class="title class_">String</span>, <span class="title class_">String</span>&gt;&gt; <span class="title function_">getFormData</span>();   </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 返回multipart请求的part数据或者一个空的Map，只有Content-Type为multipart/form-data的时候这个方法才会返回一个非空的Map  -- 这个一般是文件上传用到</span></span><br><span class="line">    <span class="title class_">Mono</span>&lt;<span class="title class_">MultiValueMap</span>&lt;<span class="title class_">String</span>, <span class="title class_">Part</span>&gt;&gt; <span class="title function_">getMultipartData</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 返回Spring的上下文</span></span><br><span class="line">    @<span class="title class_">Nullable</span></span><br><span class="line">    <span class="title class_">ApplicationContext</span> <span class="title function_">getApplicationContext</span>();   </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这几个方法和lastModified属性相关</span></span><br><span class="line">    boolean <span class="title function_">isNotModified</span>();</span><br><span class="line">    boolean <span class="title function_">checkNotModified</span>(<span class="title class_">Instant</span> lastModified);</span><br><span class="line">    boolean <span class="title function_">checkNotModified</span>(<span class="title class_">String</span> etag);</span><br><span class="line">    boolean <span class="title function_">checkNotModified</span>(@<span class="title class_">Nullable</span> <span class="title class_">String</span> etag, <span class="title class_">Instant</span> lastModified);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// URL转换</span></span><br><span class="line">    <span class="title class_">String</span> <span class="title function_">transformUrl</span>(<span class="title class_">String</span> url);    </span><br><span class="line">   </span><br><span class="line">    <span class="comment">// URL转换映射</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addUrlTransformer</span>(<span class="title class_">Function</span>&lt;<span class="title class_">String</span>, <span class="title class_">String</span>&gt; transformer); </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意这个方法，方法名是：改变，这个是修改ServerWebExchange属性的方法，返回的是一个Builder实例，Builder是ServerWebExchange的内部类</span></span><br><span class="line">    <span class="keyword">default</span> <span class="title class_">Builder</span> <span class="title function_">mutate</span>(<span class="params"></span>) {</span><br><span class="line">	     <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultServerWebExchangeBuilder</span>(<span class="variable language_">this</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    interface <span class="title class_">Builder</span> {      </span><br><span class="line">         </span><br><span class="line">        <span class="comment">// 覆盖ServerHttpRequest</span></span><br><span class="line">        <span class="title class_">Builder</span> <span class="title function_">request</span>(<span class="title class_">Consumer</span>&lt;<span class="title class_">ServerHttpRequest</span>.<span class="property">Builder</span>&gt; requestBuilderConsumer);</span><br><span class="line">        <span class="title class_">Builder</span> <span class="title function_">request</span>(<span class="title class_">ServerHttpRequest</span> request);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 覆盖ServerHttpResponse</span></span><br><span class="line">        <span class="title class_">Builder</span> <span class="title function_">response</span>(<span class="title class_">ServerHttpResponse</span> response);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 覆盖当前请求的认证用户</span></span><br><span class="line">        <span class="title class_">Builder</span> <span class="title function_">principal</span>(<span class="title class_">Mono</span>&lt;<span class="title class_">Principal</span>&gt; principalMono);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 构建新的ServerWebExchange实例</span></span><br><span class="line">        <span class="title class_">ServerWebExchange</span> <span class="title function_">build</span>();</span><br><span class="line">    }</span><br><span class="line">}    </span><br></pre></td></tr></table></figure><h3 id="serverwebexchangemutate方法"><code>ServerWebExchange#mutate()</code>方法</h3><p>注意到<code>ServerWebExchange#mutate()</code>方法，<code>ServerWebExchange</code>实例可以理解为不可变实例，</p><p>如果我们想要修改它，需要通过<code>mutate()</code>方法生成一个新的实例，例如这样：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">class</span> <span class="title class_">CustomGlobalFilter</span> implements <span class="title class_">GlobalFilter</span> {</span><br><span class="line"></span><br><span class="line">    @<span class="title class_">Override</span></span><br><span class="line">    public <span class="title class_">Mono</span>&lt;<span class="title class_">Void</span>&gt; <span class="title function_">filter</span>(<span class="params">ServerWebExchange exchange, GatewayFilterChain chain</span>) {</span><br><span class="line">        <span class="title class_">ServerHttpRequest</span> request = exchange.<span class="title function_">getRequest</span>();</span><br><span class="line">        <span class="comment">// 这里可以修改ServerHttpRequest实例</span></span><br><span class="line">        <span class="title class_">ServerHttpRequest</span> newRequest = ...</span><br><span class="line">        <span class="title class_">ServerHttpResponse</span> response = exchange.<span class="title function_">getResponse</span>();</span><br><span class="line">        <span class="comment">// 这里可以修改ServerHttpResponse实例</span></span><br><span class="line">        <span class="title class_">ServerHttpResponse</span> newResponse = ...</span><br><span class="line">        <span class="comment">// 构建新的ServerWebExchange实例</span></span><br><span class="line">        <span class="title class_">ServerWebExchange</span> newExchange = exchange.<span class="title function_">mutate</span>().<span class="title function_">request</span>(newRequest).<span class="title function_">response</span>(newResponse).<span class="title function_">build</span>();</span><br><span class="line">        <span class="keyword">return</span> chain.<span class="title function_">filter</span>(newExchange);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h3 id="serverhttprequest接口">ServerHttpRequest接口</h3><p><code>ServerHttpRequest</code>实例是用于承载请求相关的属性和请求体，</p><p><code>Spring Cloud Gateway</code>中底层使用<code>Netty</code>处理网络请求，通过追溯源码，</p><p>可以从<code>ReactorHttpHandlerAdapter</code>中得知<code>ServerWebExchange</code>实例中持有的<code>ServerHttpRequest</code>实例的具体实现是<code>ReactorServerHttpRequest</code>。</p><p>之所以列出这些实例之间的关系，是因为这样比较容易理清一些隐含的问题，例如：</p><ul><li><strong><code>ReactorServerHttpRequest</code>的父类<code>AbstractServerHttpRequest</code>中初始化内部属性headers的时候把请求的HTTP头部封装为只读的实例</strong>：</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public <span class="title class_">AbstractServerHttpRequest</span>(<span class="variable constant_">URI</span> uri, @<span class="title class_">Nullable</span> <span class="title class_">String</span> contextPath, <span class="title class_">HttpHeaders</span> headers) {</span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">uri</span> = uri;</span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">path</span> = <span class="title class_">RequestPath</span>.<span class="title function_">parse</span>(uri, contextPath);</span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">headers</span> = <span class="title class_">HttpHeaders</span>.<span class="title function_">readOnlyHttpHeaders</span>(headers);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// HttpHeaders类中的readOnlyHttpHeaders方法，</span></span><br><span class="line"><span class="comment">// ReadOnlyHttpHeaders屏蔽了所有修改请求头的方法，直接抛出UnsupportedOperationException</span></span><br><span class="line">public <span class="keyword">static</span> <span class="title class_">HttpHeaders</span> <span class="title function_">readOnlyHttpHeaders</span>(<span class="params">HttpHeaders headers</span>) {</span><br><span class="line">	<span class="title class_">Assert</span>.<span class="title function_">notNull</span>(headers, <span class="string">"HttpHeaders must not be null"</span>);</span><br><span class="line">	<span class="keyword">if</span> (headers <span class="keyword">instanceof</span> <span class="title class_">ReadOnlyHttpHeaders</span>) {</span><br><span class="line">		<span class="keyword">return</span> headers;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">else</span> {</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReadOnlyHttpHeaders</span>(headers);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>所以, <strong>不能直接从<code>ServerHttpRequest</code>实例中直接获取请求头<code>HttpHeaders</code>实例并且进行修改</strong>。</p><p><code>ServerHttpRequest</code>接口如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">public interface <span class="title class_">HttpMessage</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取请求头，目前的实现中返回的是ReadOnlyHttpHeaders实例，只读</span></span><br><span class="line">    <span class="title class_">HttpHeaders</span> <span class="title function_">getHeaders</span>();</span><br><span class="line">}    </span><br><span class="line"></span><br><span class="line">public interface <span class="title class_">ReactiveHttpInputMessage</span> <span class="keyword">extends</span> <span class="title class_">HttpMessage</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 返回请求体的Flux封装</span></span><br><span class="line">    <span class="title class_">Flux</span>&lt;<span class="title class_">DataBuffer</span>&gt; <span class="title function_">getBody</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">public interface <span class="title class_">HttpRequest</span> <span class="keyword">extends</span> <span class="title class_">HttpMessage</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回HTTP请求方法，解析为HttpMethod实例</span></span><br><span class="line">    @<span class="title class_">Nullable</span></span><br><span class="line">    <span class="keyword">default</span> <span class="title class_">HttpMethod</span> <span class="title function_">getMethod</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">HttpMethod</span>.<span class="title function_">resolve</span>(<span class="title function_">getMethodValue</span>());</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 返回HTTP请求方法，字符串</span></span><br><span class="line">    <span class="title class_">String</span> <span class="title function_">getMethodValue</span>();    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 请求的URI</span></span><br><span class="line">    <span class="variable constant_">URI</span> <span class="title function_">getURI</span>();</span><br><span class="line">}    </span><br><span class="line"></span><br><span class="line">public interface <span class="title class_">ServerHttpRequest</span> <span class="keyword">extends</span> <span class="title class_">HttpRequest</span>, <span class="title class_">ReactiveHttpInputMessage</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 连接的唯一标识或者用于日志处理标识</span></span><br><span class="line">    <span class="title class_">String</span> <span class="title function_">getId</span>();   </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取请求路径，封装为RequestPath对象</span></span><br><span class="line">    <span class="title class_">RequestPath</span> <span class="title function_">getPath</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 返回查询参数，是只读的MultiValueMap实例</span></span><br><span class="line">    <span class="title class_">MultiValueMap</span>&lt;<span class="title class_">String</span>, <span class="title class_">String</span>&gt; <span class="title function_">getQueryParams</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回Cookie集合，是只读的MultiValueMap实例</span></span><br><span class="line">    <span class="title class_">MultiValueMap</span>&lt;<span class="title class_">String</span>, <span class="title class_">HttpCookie</span>&gt; <span class="title function_">getCookies</span>();  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 远程服务器地址信息</span></span><br><span class="line">    @<span class="title class_">Nullable</span></span><br><span class="line">    <span class="keyword">default</span> <span class="title class_">InetSocketAddress</span> <span class="title function_">getRemoteAddress</span>(<span class="params"></span>) {</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SSL会话实现的相关信息</span></span><br><span class="line">    @<span class="title class_">Nullable</span></span><br><span class="line">    <span class="keyword">default</span> <span class="title class_">SslInfo</span> <span class="title function_">getSslInfo</span>(<span class="params"></span>) {</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 修改请求的方法，返回一个建造器实例Builder，Builder是内部类</span></span><br><span class="line">    <span class="keyword">default</span> <span class="title class_">ServerHttpRequest</span>.<span class="property">Builder</span> <span class="title function_">mutate</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultServerHttpRequestBuilder</span>(<span class="variable language_">this</span>);</span><br><span class="line">    } </span><br><span class="line"></span><br><span class="line">    interface <span class="title class_">Builder</span> {</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 覆盖请求方法</span></span><br><span class="line">        <span class="title class_">Builder</span> <span class="title function_">method</span>(<span class="title class_">HttpMethod</span> httpMethod);</span><br><span class="line">		 </span><br><span class="line">        <span class="comment">// 覆盖请求的URI、请求路径或者上下文，这三者相互有制约关系，具体可以参考API注释</span></span><br><span class="line">        <span class="title class_">Builder</span> <span class="title function_">uri</span>(<span class="variable constant_">URI</span> uri);</span><br><span class="line">        <span class="title class_">Builder</span> <span class="title function_">path</span>(<span class="title class_">String</span> path);</span><br><span class="line">        <span class="title class_">Builder</span> <span class="title function_">contextPath</span>(<span class="title class_">String</span> contextPath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 覆盖请求头</span></span><br><span class="line">        <span class="title class_">Builder</span> <span class="title function_">header</span>(<span class="title class_">String</span> key, <span class="title class_">String</span> value);</span><br><span class="line">        <span class="title class_">Builder</span> <span class="title function_">headers</span>(<span class="title class_">Consumer</span>&lt;<span class="title class_">HttpHeaders</span>&gt; headersConsumer);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 覆盖SslInfo</span></span><br><span class="line">        <span class="title class_">Builder</span> <span class="title function_">sslInfo</span>(<span class="title class_">SslInfo</span> sslInfo);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 构建一个新的ServerHttpRequest实例</span></span><br><span class="line">        <span class="title class_">ServerHttpRequest</span> <span class="title function_">build</span>();</span><br><span class="line">    }         </span><br><span class="line">}    </span><br></pre></td></tr></table></figure><p><strong>注意：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ServerHttpRequest`或者说`HttpMessage`接口提供的获取请求头方法`HttpHeaders getHeaders();</span><br></pre></td></tr></table></figure><p>返回结果是一个只读的实例，具体是<code>ReadOnlyHttpHeaders</code>类型，</p><p>如果要修改<code>ServerHttpRequest</code>实例，那么需要这样做：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line"><span class="type">ServerHttpRequest</span> <span class="variable">newRequest</span> <span class="operator">=</span> request.mutate().header(<span class="string">"key"</span>,<span class="string">"value"</span>).path(<span class="string">"/myPath"</span>).build();</span><br></pre></td></tr></table></figure><h3 id="serverhttpresponse接口">ServerHttpResponse接口</h3><p><code>ServerHttpResponse</code>实例是用于承载响应相关的属性和响应体，</p><p><code>Spring Cloud Gateway</code>中底层使用<code>Netty</code>处理网络请求，通过追溯源码，可以从<code>ReactorHttpHandlerAdapter</code>中得知<code>ServerWebExchange</code>实例中持有的<code>ServerHttpResponse</code>实例的具体实现是<code>ReactorServerHttpResponse</code>。</p><p>之所以列出这些实例之间的关系，是因为这样比较容易理清一些隐含的问题，例如：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReactorServerHttpResponse的父类</span></span><br><span class="line">public <span class="title class_">AbstractServerHttpResponse</span>(<span class="title class_">DataBufferFactory</span> dataBufferFactory, <span class="title class_">HttpHeaders</span> headers) {</span><br><span class="line">	<span class="title class_">Assert</span>.<span class="title function_">notNull</span>(dataBufferFactory, <span class="string">"DataBufferFactory must not be null"</span>);</span><br><span class="line">	<span class="title class_">Assert</span>.<span class="title function_">notNull</span>(headers, <span class="string">"HttpHeaders must not be null"</span>);</span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">dataBufferFactory</span> = dataBufferFactory;</span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">headers</span> = headers;</span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">cookies</span> = <span class="keyword">new</span> <span class="title class_">LinkedMultiValueMap</span>&lt;&gt;();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">public <span class="title class_">ReactorServerHttpResponse</span>(<span class="title class_">HttpServerResponse</span> response, <span class="title class_">DataBufferFactory</span> bufferFactory) {</span><br><span class="line">	<span class="variable language_">super</span>(bufferFactory, <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>(<span class="keyword">new</span> <span class="title class_">NettyHeadersAdapter</span>(response.<span class="title function_">responseHeaders</span>())));</span><br><span class="line">	<span class="title class_">Assert</span>.<span class="title function_">notNull</span>(response, <span class="string">"HttpServerResponse must not be null"</span>);</span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">response</span> = response;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>可知<code>ReactorServerHttpResponse</code>构造函数初始化实例的时候，存放响应Header的是<code>HttpHeaders</code>实例，也就是响应Header是可以直接修改的。</p><p><code>ServerHttpResponse</code>接口如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">public interface <span class="title class_">HttpMessage</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取响应Header，目前的实现中返回的是HttpHeaders实例，可以直接修改</span></span><br><span class="line">    <span class="title class_">HttpHeaders</span> <span class="title function_">getHeaders</span>();</span><br><span class="line">}  </span><br><span class="line"></span><br><span class="line">public interface <span class="title class_">ReactiveHttpOutputMessage</span> <span class="keyword">extends</span> <span class="title class_">HttpMessage</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取DataBufferFactory实例，用于包装或者生成数据缓冲区DataBuffer实例(创建响应体)</span></span><br><span class="line">    <span class="title class_">DataBufferFactory</span> <span class="title function_">bufferFactory</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册一个动作，在HttpOutputMessage提交之前此动作会进行回调</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">beforeCommit</span>(<span class="title class_">Supplier</span>&lt;? <span class="keyword">extends</span> <span class="title class_">Mono</span>&lt;<span class="title class_">Void</span>&gt;&gt; action);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断HttpOutputMessage是否已经提交</span></span><br><span class="line">    boolean <span class="title function_">isCommitted</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 写入消息体到HTTP协议层</span></span><br><span class="line">    <span class="title class_">Mono</span>&lt;<span class="title class_">Void</span>&gt; <span class="title function_">writeWith</span>(<span class="title class_">Publisher</span>&lt;? <span class="keyword">extends</span> <span class="title class_">DataBuffer</span>&gt; body);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写入消息体到HTTP协议层并且刷新缓冲区</span></span><br><span class="line">    <span class="title class_">Mono</span>&lt;<span class="title class_">Void</span>&gt; <span class="title function_">writeAndFlushWith</span>(<span class="title class_">Publisher</span>&lt;? <span class="keyword">extends</span> <span class="title class_">Publisher</span>&lt;? <span class="keyword">extends</span> <span class="title class_">DataBuffer</span>&gt;&gt; body);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 指明消息处理已经结束，一般在消息处理结束自动调用此方法，多次调用不会产生副作用</span></span><br><span class="line">    <span class="title class_">Mono</span>&lt;<span class="title class_">Void</span>&gt; <span class="title function_">setComplete</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">public interface <span class="title class_">ServerHttpResponse</span> <span class="keyword">extends</span> <span class="title class_">ReactiveHttpOutputMessage</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置响应状态码</span></span><br><span class="line">    boolean <span class="title function_">setStatusCode</span>(@<span class="title class_">Nullable</span> <span class="title class_">HttpStatus</span> status);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取响应状态码</span></span><br><span class="line">    @<span class="title class_">Nullable</span></span><br><span class="line">    <span class="title class_">HttpStatus</span> <span class="title function_">getStatusCode</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取响应Cookie，封装为MultiValueMap实例，可以修改</span></span><br><span class="line">    <span class="title class_">MultiValueMap</span>&lt;<span class="title class_">String</span>, <span class="title class_">ResponseCookie</span>&gt; <span class="title function_">getCookies</span>();  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加响应Cookie</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addCookie</span>(<span class="title class_">ResponseCookie</span> cookie);  </span><br><span class="line">}    </span><br></pre></td></tr></table></figure><p>这里可以看到除了响应体比较难修改之外，其他的属性都是可变的。</p><h3 id="serverwebexchangeutils和上下文属性">ServerWebExchangeUtils和上下文属性</h3><p><code>ServerWebExchangeUtils</code>里面存放了很多静态公有的字符串KEY值</p><p>(<strong>这些字符串KEY的实际值是</strong><code>org.springframework.cloud.gateway.support.ServerWebExchangeUtils.</code> + 下面任意的静态公有KEY)，</p><p>这些字符串KEY值一般是用于<code>ServerWebExchange</code>的属性(<code>Attribute</code>，见上文的<code>ServerWebExchange#getAttributes()</code>方法)的KEY，这些属性值都是有特殊的含义，在使用过滤器的时候如果时机适当可以直接取出来使用，下面逐个分析。</p><ul><li><code>PRESERVE_HOST_HEADER_ATTRIBUTE</code>：是否保存Host属性，值是布尔值类型，写入位置是<code>PreserveHostHeaderGatewayFilterFactory</code>，使用的位置是<code>NettyRoutingFilter</code>，作用是如果设置为true，HTTP请求头中的Host属性会写到底层Reactor-Netty的请求Header属性中。</li><li><code>CLIENT_RESPONSE_ATTR</code>：保存底层Reactor-Netty的响应对象，类型是<code>reactor.netty.http.client.HttpClientResponse</code>。</li><li><code>CLIENT_RESPONSE_CONN_ATTR</code>：保存底层Reactor-Netty的连接对象，类型是<code>reactor.netty.Connection</code>。</li><li><code>URI_TEMPLATE_VARIABLES_ATTRIBUTE</code>：<code>PathRoutePredicateFactory</code>解析路径参数完成之后，把解析完成后的占位符KEY-路径Path映射存放在<code>ServerWebExchange</code>的属性中，KEY就是<code>URI_TEMPLATE_VARIABLES_ATTRIBUTE</code>。</li><li><code>CLIENT_RESPONSE_HEADER_NAMES</code>：保存底层Reactor-Netty的响应Header的名称集合。</li><li><code>GATEWAY_ROUTE_ATTR</code>：用于存放<code>RoutePredicateHandlerMapping</code>中匹配出来的具体的路由(<code>org.springframework.cloud.gateway.route.Route</code>)实例，通过这个路由实例可以得知当前请求会路由到下游哪个服务。</li><li><code>GATEWAY_REQUEST_URL_ATTR</code>：<code>java.net.URI</code>类型的实例，这个实例代表直接请求或者<a target="_blank" rel="noopener external nofollow noreferrer" href="https://cloud.tencent.com/product/clb?from=10680">负载均衡</a>处理之后需要请求到下游服务的真实URI。</li><li><code>GATEWAY_ORIGINAL_REQUEST_URL_ATTR</code>：<code>java.net.URI</code>类型的实例，需要重写请求URI的时候，保存原始的请求URI。</li><li><code>GATEWAY_HANDLER_MAPPER_ATTR</code>：保存当前使用的<code>HandlerMapping</code>具体实例的类型简称(一般是字符串"RoutePredicateHandlerMapping")。</li><li><code>GATEWAY_SCHEME_PREFIX_ATTR</code>：确定目标路由URI中如果存在schemeSpecificPart属性，则保存该URI的scheme在此属性中，路由URI会被重新构造，见<code>RouteToRequestUrlFilter</code>。</li><li><code>GATEWAY_PREDICATE_ROUTE_ATTR</code>：用于存放<code>RoutePredicateHandlerMapping</code>中匹配出来的具体的路由(<code>org.springframework.cloud.gateway.route.Route</code>)实例的ID。</li><li><code>WEIGHT_ATTR</code>：实验性功能(此版本还不建议在正式版本使用)存放分组权重相关属性，见<code>WeightCalculatorWebFilter</code>。</li><li><code>ORIGINAL_RESPONSE_CONTENT_TYPE_ATTR</code>：存放响应Header中的ContentType的值。</li><li><code>HYSTRIX_EXECUTION_EXCEPTION_ATTR</code>：<code>Throwable</code>的实例，存放的是Hystrix执行异常时候的异常实例，见<code>HystrixGatewayFilterFactory</code>。</li><li><code>GATEWAY_ALREADY_ROUTED_ATTR</code>：布尔值，用于判断是否已经进行了路由，见<code>NettyRoutingFilter</code>。</li><li><code>GATEWAY_ALREADY_PREFIXED_ATTR</code>：布尔值，用于判断请求路径是否被添加了前置部分，见<code>PrefixPathGatewayFilterFactory</code>。</li></ul><p><code>ServerWebExchangeUtils</code>提供的上下文属性用于<code>Spring Cloud Gateway</code>的<code>ServerWebExchange</code>组件处理请求和响应的时候，内部一些重要实例或者标识属性的安全传输和使用，使用它们可能存在一定的风险，</p><p>因为没有人可以确定在版本升级之后，原有的属性KEY或者VALUE是否会发生改变，如果评估过风险或者规避了风险之后，可以安心使用。</p><p>例如我们**在做请求和响应日志(类似Nginx的Access Log)的时候，可以依赖到<code>GATEWAY_ROUTE_ATTR</code>，因为我们要打印路由的目标信息。**举个简单例子：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title class_">Slf4</span>j</span><br><span class="line">@<span class="title class_">Component</span></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">AccessLogFilter</span> implements <span class="title class_">GlobalFilter</span> {</span><br><span class="line"></span><br><span class="line">    @<span class="title class_">Override</span></span><br><span class="line">    public <span class="title class_">Mono</span>&lt;<span class="title class_">Void</span>&gt; <span class="title function_">filter</span>(<span class="params">ServerWebExchange exchange, GatewayFilterChain chain</span>) {</span><br><span class="line">        <span class="title class_">ServerHttpRequest</span> request = exchange.<span class="title function_">getRequest</span>();</span><br><span class="line">        <span class="title class_">String</span> path = request.<span class="title function_">getPath</span>().<span class="title function_">pathWithinApplication</span>().<span class="title function_">value</span>();</span><br><span class="line">        <span class="title class_">HttpMethod</span> method = request.<span class="title function_">getMethod</span>();</span><br><span class="line">        <span class="comment">// 获取路由的目标URI</span></span><br><span class="line">        <span class="variable constant_">URI</span> targetUri = exchange.<span class="title function_">getAttribute</span>(<span class="title class_">ServerWebExchangeUtils</span>.<span class="property">GATEWAY_REQUEST_URL_ATTR</span>);</span><br><span class="line">        <span class="title class_">InetSocketAddress</span> remoteAddress = request.<span class="title function_">getRemoteAddress</span>();</span><br><span class="line">        <span class="keyword">return</span> chain.<span class="title function_">filter</span>(exchange.<span class="title function_">mutate</span>().<span class="title function_">build</span>()).<span class="title function_">then</span>(<span class="title class_">Mono</span>.<span class="title function_">fromRunnable</span>(() -&gt; {</span><br><span class="line">            <span class="title class_">ServerHttpResponse</span> response = exchange.<span class="title function_">getResponse</span>();</span><br><span class="line">            <span class="title class_">HttpStatus</span> statusCode = response.<span class="title function_">getStatusCode</span>();</span><br><span class="line">            log.<span class="title function_">info</span>(<span class="string">"请求路径:{},客户端远程IP地址:{},请求方法:{},目标URI:{},响应码:{}"</span>,</span><br><span class="line">                    path, remoteAddress, method, targetUri, statusCode);</span><br><span class="line">        }));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h3 id="修改请求体">修改请求体</h3><p>修改请求体是一个比较常见的需求。</p><p>例如我们使用<code>Spring Cloud Gateway</code>实现网关的时候，要实现一个功能：</p><blockquote><p>把存放在请求头中的JWT解析后，提取里面的用户ID，然后写入到请求体中。</p></blockquote><p>我们简化这个场景，假设我们把userId明文存放在请求头中的accessToken中，请求体是一个JSON结构：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="string">"serialNumber"</span>: <span class="string">"请求流水号"</span>,</span><br><span class="line">    <span class="string">"payload"</span> : {</span><br><span class="line">        <span class="comment">// ... 这里是有效载荷，存放具体的数据</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>我们需要提取accessToken，也就是userId插入到请求体JSON中如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="string">"userId"</span>: <span class="string">"用户ID"</span>,</span><br><span class="line">    <span class="string">"serialNumber"</span>: <span class="string">"请求流水号"</span>,</span><br><span class="line">    <span class="string">"payload"</span> : {</span><br><span class="line">        <span class="comment">// ... 这里是有效载荷，存放具体的数据</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>这里为了简化设计，用全局过滤器<code>GlobalFilter</code>实现，实际需要结合具体场景考虑：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title class_">Slf4</span>j</span><br><span class="line">@<span class="title class_">Component</span></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">ModifyRequestBodyGlobalFilter</span> implements <span class="title class_">GlobalFilter</span> {</span><br><span class="line"></span><br><span class="line">    private final <span class="title class_">DataBufferFactory</span> dataBufferFactory = <span class="keyword">new</span> <span class="title class_">NettyDataBufferFactory</span>(<span class="title class_">ByteBufAllocator</span>.<span class="property">DEFAULT</span>);</span><br><span class="line"></span><br><span class="line">    @<span class="title class_">Autowired</span></span><br><span class="line">    private <span class="title class_">ObjectMapper</span> objectMapper;</span><br><span class="line"></span><br><span class="line">    @<span class="title class_">Override</span></span><br><span class="line">    public <span class="title class_">Mono</span>&lt;<span class="title class_">Void</span>&gt; <span class="title function_">filter</span>(<span class="params">ServerWebExchange exchange, GatewayFilterChain chain</span>) {</span><br><span class="line">        <span class="title class_">ServerHttpRequest</span> request = exchange.<span class="title function_">getRequest</span>();</span><br><span class="line">        <span class="title class_">String</span> accessToken = request.<span class="title function_">getHeaders</span>().<span class="title function_">getFirst</span>(<span class="string">"accessToken"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title class_">StringUtils</span>.<span class="title function_">hasLength</span>(accessToken)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">"accessToken"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 新建一个ServerHttpRequest装饰器,覆盖需要装饰的方法</span></span><br><span class="line">        <span class="title class_">ServerHttpRequestDecorator</span> decorator = <span class="keyword">new</span> <span class="title class_">ServerHttpRequestDecorator</span>(request) {</span><br><span class="line"></span><br><span class="line">            @<span class="title class_">Override</span></span><br><span class="line">            public <span class="title class_">Flux</span>&lt;<span class="title class_">DataBuffer</span>&gt; <span class="title function_">getBody</span>(<span class="params"></span>) {</span><br><span class="line">                <span class="title class_">Flux</span>&lt;<span class="title class_">DataBuffer</span>&gt; body = <span class="variable language_">super</span>.<span class="title function_">getBody</span>();</span><br><span class="line">                <span class="title class_">InputStreamHolder</span> holder = <span class="keyword">new</span> <span class="title class_">InputStreamHolder</span>();</span><br><span class="line">                body.<span class="title function_">subscribe</span>(buffer -&gt; holder.<span class="property">inputStream</span> = buffer.<span class="title function_">asInputStream</span>());</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> != holder.<span class="property">inputStream</span>) {</span><br><span class="line">                    <span class="keyword">try</span> {</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// 解析JSON的节点</span></span><br><span class="line">                        <span class="title class_">JsonNode</span> jsonNode = objectMapper.<span class="title function_">readTree</span>(holder.<span class="property">inputStream</span>);</span><br><span class="line">                        <span class="title class_">Assert</span>.<span class="title function_">isTrue</span>(jsonNode <span class="keyword">instanceof</span> <span class="title class_">ObjectNode</span>, <span class="string">"JSON格式异常"</span>);</span><br><span class="line">                        <span class="title class_">ObjectNode</span> objectNode = (<span class="title class_">ObjectNode</span>) jsonNode;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// JSON节点最外层写入新的属性</span></span><br><span class="line">                        objectNode.<span class="title function_">put</span>(<span class="string">"userId"</span>, accessToken);</span><br><span class="line">                        <span class="title class_">DataBuffer</span> dataBuffer = dataBufferFactory.<span class="title function_">allocateBuffer</span>();</span><br><span class="line">                        <span class="title class_">String</span> json = objectNode.<span class="title function_">toString</span>();</span><br><span class="line">                        log.<span class="title function_">info</span>(<span class="string">"最终的JSON数据为:{}"</span>, json);</span><br><span class="line">                        dataBuffer.<span class="title function_">write</span>(json.<span class="title function_">getBytes</span>(<span class="title class_">StandardCharsets</span>.<span class="property">UTF_8</span>));</span><br><span class="line">                        </span><br><span class="line">                        <span class="keyword">return</span> <span class="title class_">Flux</span>.<span class="title function_">just</span>(dataBuffer);</span><br><span class="line">                    } <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) {</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e);</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">super</span>.<span class="title function_">getBody</span>();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">        <span class="comment">// 使用修改后的ServerHttpRequestDecorator重新生成一个新的ServerWebExchange</span></span><br><span class="line">        <span class="keyword">return</span> chain.<span class="title function_">filter</span>(exchange.<span class="title function_">mutate</span>().<span class="title function_">request</span>(decorator).<span class="title function_">build</span>());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private <span class="keyword">class</span> <span class="title class_">InputStreamHolder</span> {</span><br><span class="line"></span><br><span class="line">        <span class="title class_">InputStream</span> inputStream;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>测试一下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HTTP</span></span><br><span class="line"><span class="variable constant_">POST</span> /order/json <span class="variable constant_">HTTP</span>/<span class="number">1.1</span></span><br><span class="line"><span class="title class_">Host</span>: <span class="attr">localhost</span>:<span class="number">9090</span></span><br><span class="line"><span class="title class_">Content</span>-<span class="title class_">Type</span>: application/json</span><br><span class="line"><span class="attr">accessToken</span>: <span class="number">10086</span></span><br><span class="line"><span class="title class_">Accept</span>: *<span class="comment">/*</span></span><br><span class="line"><span class="comment">Cache-Control: no-cache</span></span><br><span class="line"><span class="comment">Host: localhost:9090</span></span><br><span class="line"><span class="comment">accept-encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">content-length: 94</span></span><br><span class="line"><span class="comment">Connection: keep-alive</span></span><br><span class="line"><span class="comment">cache-control: no-cache</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">{</span></span><br><span class="line"><span class="comment">    "serialNumber": "请求流水号",</span></span><br><span class="line"><span class="comment">    "payload": {</span></span><br><span class="line"><span class="comment">        "name": "doge"</span></span><br><span class="line"><span class="comment">    }</span></span><br><span class="line"><span class="comment">}</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">// 日志输出</span></span><br><span class="line"><span class="comment">最终的JSON数据为:{"serialNumber":"请求流水号","payload":{"name":"doge"},"userId":"10086"}</span></span><br></pre></td></tr></table></figure><p>最重要的是用到了<code>ServerHttpRequest</code>装饰器<code>ServerHttpRequestDecorator</code>，主要覆盖对应获取请求体数据缓冲区的方法即可，至于怎么处理其他逻辑需要自行考虑，这里只是做一个简单的示范。</p><p>一般的代码逻辑如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ServerHttpRequest</span> request = exchange.<span class="title function_">getRequest</span>();</span><br><span class="line"><span class="title class_">ServerHttpRequestDecorator</span> requestDecorator = <span class="keyword">new</span> <span class="title class_">ServerHttpRequestDecorator</span>(request) {</span><br><span class="line"></span><br><span class="line">     @<span class="title class_">Override</span></span><br><span class="line">     public <span class="title class_">Flux</span>&lt;<span class="title class_">DataBuffer</span>&gt; <span class="title function_">getBody</span>(<span class="params"></span>) {</span><br><span class="line">         <span class="comment">// 拿到承载原始请求体的Flux</span></span><br><span class="line">         <span class="title class_">Flux</span>&lt;<span class="title class_">DataBuffer</span>&gt; body = <span class="variable language_">super</span>.<span class="title function_">getBody</span>();</span><br><span class="line">         <span class="comment">// 这里通过自定义方式生成新的承载请求体的Flux</span></span><br><span class="line">         <span class="title class_">Flux</span>&lt;<span class="title class_">DataBuffer</span>&gt; newBody = ...</span><br><span class="line">         <span class="keyword">return</span> newBody;</span><br><span class="line">     }            </span><br><span class="line">}</span><br><span class="line"><span class="keyword">return</span> chain.<span class="title function_">filter</span>(exchange.<span class="title function_">mutate</span>().<span class="title function_">request</span>(requestDecorator).<span class="title function_">build</span>());    </span><br></pre></td></tr></table></figure><h3 id="修改响应体">修改响应体</h3><p>修改响应体的需求也是比较常见的，具体的做法和修改请求体差不多。</p><p>例如我们想要实现下面的功能：第三方服务请求经过网关，原始报文是密文，我们需要在网关实现密文解密，然后把解密后的明文路由到下游服务，下游服务处理成功响应明文，需要在网关把明文加密成密文再返回到第三方服务。</p><p>现在简化整个流程，用AES加密算法，统一密码为字符串"throwable"，假设请求报文和响应报文明文如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 请求密文</span></span><br><span class="line">{</span><br><span class="line">    <span class="string">"serialNumber"</span>: <span class="string">"请求流水号"</span>,</span><br><span class="line">    <span class="string">"payload"</span> : <span class="string">"加密后的请求消息载荷"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求明文（仅仅作为提示）</span></span><br><span class="line">{</span><br><span class="line">    <span class="string">"serialNumber"</span>: <span class="string">"请求流水号"</span>,</span><br><span class="line">    <span class="string">"payload"</span> : <span class="string">"{\"name:\":\"doge\"}"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 响应密文</span></span><br><span class="line">{</span><br><span class="line">    <span class="string">"code"</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="string">"message"</span>:<span class="string">"ok"</span>,</span><br><span class="line">    <span class="string">"payload"</span> : <span class="string">"加密后的响应消息载荷"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 响应明文（仅仅作为提示）</span></span><br><span class="line">{</span><br><span class="line">    <span class="string">"code"</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="string">"message"</span>:<span class="string">"ok"</span>,</span><br><span class="line">    <span class="string">"payload"</span> : <span class="string">"{\"name:\":\"doge\",\"age\":26}"</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>为了方便一些加解密或者编码解码的实现，需要引入<code>Apache</code>的<code>commons-codec</code>类库：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>这里定义一个全局过滤器专门处理加解密，实际上最好结合真实的场景决定是否适合全局过滤器，这里只是一个示例：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AES加解密工具类</span></span><br><span class="line">public enum <span class="title class_">AesUtils</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 单例</span></span><br><span class="line">    X;</span><br><span class="line"></span><br><span class="line">    private <span class="keyword">static</span> final <span class="title class_">String</span> <span class="variable constant_">PASSWORD</span> = <span class="string">"throwable"</span>;</span><br><span class="line">    private <span class="keyword">static</span> final <span class="title class_">String</span> <span class="variable constant_">KEY_ALGORITHM</span> = <span class="string">"AES"</span>;</span><br><span class="line">    private <span class="keyword">static</span> final <span class="title class_">String</span> <span class="variable constant_">SECURE_RANDOM_ALGORITHM</span> = <span class="string">"SHA1PRNG"</span>;</span><br><span class="line">    private <span class="keyword">static</span> final <span class="title class_">String</span> <span class="variable constant_">DEFAULT_CIPHER_ALGORITHM</span> = <span class="string">"AES/ECB/PKCS5Padding"</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="title class_">String</span> <span class="title function_">encrypt</span>(<span class="params"><span class="built_in">String</span> content</span>) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="title class_">Cipher</span> cipher = <span class="title class_">Cipher</span>.<span class="title function_">getInstance</span>(<span class="variable constant_">DEFAULT_CIPHER_ALGORITHM</span>);</span><br><span class="line">            cipher.<span class="title function_">init</span>(<span class="title class_">Cipher</span>.<span class="property">ENCRYPT_MODE</span>, <span class="title function_">provideSecretKey</span>());</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">Hex</span>.<span class="title function_">encodeHexString</span>(cipher.<span class="title function_">doFinal</span>(content.<span class="title function_">getBytes</span>(<span class="title class_">StandardCharsets</span>.<span class="property">UTF_8</span>)));</span><br><span class="line">        } <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    public byte[] <span class="title function_">decrypt</span>(<span class="params"><span class="built_in">String</span> content</span>) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="title class_">Cipher</span> cipher = <span class="title class_">Cipher</span>.<span class="title function_">getInstance</span>(<span class="variable constant_">DEFAULT_CIPHER_ALGORITHM</span>);</span><br><span class="line">            cipher.<span class="title function_">init</span>(<span class="title class_">Cipher</span>.<span class="property">DECRYPT_MODE</span>, <span class="title function_">provideSecretKey</span>());</span><br><span class="line">            <span class="keyword">return</span> cipher.<span class="title function_">doFinal</span>(<span class="title class_">Hex</span>.<span class="title function_">decodeHex</span>(content));</span><br><span class="line">        } <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private <span class="title class_">SecretKey</span> <span class="title function_">provideSecretKey</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="title class_">KeyGenerator</span> keyGen = <span class="title class_">KeyGenerator</span>.<span class="title function_">getInstance</span>(<span class="variable constant_">KEY_ALGORITHM</span>);</span><br><span class="line">            <span class="title class_">SecureRandom</span> secureRandom = <span class="title class_">SecureRandom</span>.<span class="title function_">getInstance</span>(<span class="variable constant_">SECURE_RANDOM_ALGORITHM</span>);</span><br><span class="line">            secureRandom.<span class="title function_">setSeed</span>(<span class="variable constant_">PASSWORD</span>.<span class="title function_">getBytes</span>(<span class="title class_">StandardCharsets</span>.<span class="property">UTF_8</span>));</span><br><span class="line">            keyGen.<span class="title function_">init</span>(<span class="number">128</span>, secureRandom);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(keyGen.<span class="title function_">generateKey</span>().<span class="title function_">getEncoded</span>(), <span class="variable constant_">KEY_ALGORITHM</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// EncryptionGlobalFilter</span></span><br><span class="line">@<span class="title class_">Slf4</span>j</span><br><span class="line">@<span class="title class_">Component</span></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">EncryptionGlobalFilter</span> implements <span class="title class_">GlobalFilter</span>, <span class="title class_">Ordered</span> {</span><br><span class="line"></span><br><span class="line">    @<span class="title class_">Autowired</span></span><br><span class="line">    private <span class="title class_">ObjectMapper</span> objectMapper;</span><br><span class="line"></span><br><span class="line">    @<span class="title class_">Override</span></span><br><span class="line">    public int <span class="title function_">getOrder</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">2</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    @<span class="title class_">Override</span></span><br><span class="line">    public <span class="title class_">Mono</span>&lt;<span class="title class_">Void</span>&gt; <span class="title function_">filter</span>(<span class="params">ServerWebExchange exchange, GatewayFilterChain chain</span>) {</span><br><span class="line">        <span class="title class_">ServerHttpRequest</span> request = exchange.<span class="title function_">getRequest</span>();</span><br><span class="line">        <span class="comment">// 响应体</span></span><br><span class="line">        <span class="title class_">ServerHttpResponse</span> response = exchange.<span class="title function_">getResponse</span>();</span><br><span class="line">        <span class="title class_">DataBufferFactory</span> bufferFactory = exchange.<span class="title function_">getResponse</span>().<span class="title function_">bufferFactory</span>();</span><br><span class="line">        <span class="title class_">ServerHttpRequestDecorator</span> requestDecorator = <span class="title function_">processRequest</span>(request, bufferFactory);</span><br><span class="line">        <span class="title class_">ServerHttpResponseDecorator</span> responseDecorator = <span class="title function_">processResponse</span>(response, bufferFactory);</span><br><span class="line">        <span class="keyword">return</span> chain.<span class="title function_">filter</span>(exchange.<span class="title function_">mutate</span>().<span class="title function_">request</span>(requestDecorator).<span class="title function_">response</span>(responseDecorator).<span class="title function_">build</span>());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private <span class="title class_">ServerHttpRequestDecorator</span> <span class="title function_">processRequest</span>(<span class="params">ServerHttpRequest request, DataBufferFactory bufferFactory</span>) {</span><br><span class="line">        <span class="title class_">Flux</span>&lt;<span class="title class_">DataBuffer</span>&gt; body = request.<span class="title function_">getBody</span>();</span><br><span class="line">        <span class="title class_">DataBufferHolder</span> holder = <span class="keyword">new</span> <span class="title class_">DataBufferHolder</span>();</span><br><span class="line">        body.<span class="title function_">subscribe</span>(dataBuffer -&gt; {</span><br><span class="line">            int len = dataBuffer.<span class="title function_">readableByteCount</span>();</span><br><span class="line">            holder.<span class="property">length</span> = len;</span><br><span class="line">            byte[] bytes = <span class="keyword">new</span> byte[len];</span><br><span class="line">            dataBuffer.<span class="title function_">read</span>(bytes);</span><br><span class="line">            <span class="title class_">DataBufferUtils</span>.<span class="title function_">release</span>(dataBuffer);</span><br><span class="line">            <span class="title class_">String</span> text = <span class="keyword">new</span> <span class="title class_">String</span>(bytes, <span class="title class_">StandardCharsets</span>.<span class="property">UTF_8</span>);</span><br><span class="line">            <span class="title class_">JsonNode</span> jsonNode = <span class="title function_">readNode</span>(text);</span><br><span class="line">            <span class="title class_">JsonNode</span> payload = jsonNode.<span class="title function_">get</span>(<span class="string">"payload"</span>);</span><br><span class="line">            <span class="title class_">String</span> payloadText = payload.<span class="title function_">asText</span>();</span><br><span class="line">            byte[] content = <span class="title class_">AesUtils</span>.<span class="property">X</span>.<span class="title function_">decrypt</span>(payloadText);</span><br><span class="line">            <span class="title class_">String</span> requestBody = <span class="keyword">new</span> <span class="title class_">String</span>(content, <span class="title class_">StandardCharsets</span>.<span class="property">UTF_8</span>);</span><br><span class="line">            log.<span class="title function_">info</span>(<span class="string">"修改请求体payload,修改前:{},修改后:{}"</span>, payloadText, requestBody);</span><br><span class="line">            <span class="title function_">rewritePayloadNode</span>(requestBody, jsonNode);</span><br><span class="line">            <span class="title class_">DataBuffer</span> data = bufferFactory.<span class="title function_">allocateBuffer</span>();</span><br><span class="line">            data.<span class="title function_">write</span>(jsonNode.<span class="title function_">toString</span>().<span class="title function_">getBytes</span>(<span class="title class_">StandardCharsets</span>.<span class="property">UTF_8</span>));</span><br><span class="line">            holder.<span class="property">dataBuffer</span> = data;</span><br><span class="line">        });</span><br><span class="line">        <span class="title class_">HttpHeaders</span> headers = <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.<span class="title function_">putAll</span>(request.<span class="title function_">getHeaders</span>());</span><br><span class="line">        headers.<span class="title function_">remove</span>(<span class="title class_">HttpHeaders</span>.<span class="property">CONTENT_LENGTH</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServerHttpRequestDecorator</span>(request) {</span><br><span class="line"></span><br><span class="line">            @<span class="title class_">Override</span></span><br><span class="line">            public <span class="title class_">HttpHeaders</span> <span class="title function_">getHeaders</span>(<span class="params"></span>) {</span><br><span class="line">                int contentLength = holder.<span class="property">length</span>;</span><br><span class="line">                <span class="keyword">if</span> (contentLength &gt; <span class="number">0</span>) {</span><br><span class="line">                    headers.<span class="title function_">setContentLength</span>(contentLength);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    headers.<span class="title function_">set</span>(<span class="title class_">HttpHeaders</span>.<span class="property">TRANSFER_ENCODING</span>, <span class="string">"chunked"</span>);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">return</span> headers;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            @<span class="title class_">Override</span></span><br><span class="line">            public <span class="title class_">Flux</span>&lt;<span class="title class_">DataBuffer</span>&gt; <span class="title function_">getBody</span>(<span class="params"></span>) {</span><br><span class="line">                <span class="keyword">return</span> <span class="title class_">Flux</span>.<span class="title function_">just</span>(holder.<span class="property">dataBuffer</span>);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private <span class="title class_">ServerHttpResponseDecorator</span> <span class="title function_">processResponse</span>(<span class="params">ServerHttpResponse response, DataBufferFactory bufferFactory</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServerHttpResponseDecorator</span>(response) {</span><br><span class="line"></span><br><span class="line">            @<span class="title class_">SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">            @<span class="title class_">Override</span></span><br><span class="line">            public <span class="title class_">Mono</span>&lt;<span class="title class_">Void</span>&gt; <span class="title function_">writeWith</span>(<span class="params">Publisher&lt;? <span class="keyword">extends</span> DataBuffer&gt; body</span>) {</span><br><span class="line">                <span class="keyword">if</span> (body <span class="keyword">instanceof</span> <span class="title class_">Flux</span>) {</span><br><span class="line">                    <span class="title class_">Flux</span>&lt;? <span class="keyword">extends</span> <span class="title class_">DataBuffer</span>&gt; flux = (<span class="title class_">Flux</span>&lt;? <span class="keyword">extends</span> <span class="title class_">DataBuffer</span>&gt;) body;</span><br><span class="line">                    <span class="keyword">return</span> <span class="variable language_">super</span>.<span class="title function_">writeWith</span>(flux.<span class="title function_">map</span>(buffer -&gt; {</span><br><span class="line">                        <span class="title class_">CharBuffer</span> charBuffer = <span class="title class_">StandardCharsets</span>.<span class="property">UTF_8</span>.<span class="title function_">decode</span>(buffer.<span class="title function_">asByteBuffer</span>());</span><br><span class="line">                        <span class="title class_">DataBufferUtils</span>.<span class="title function_">release</span>(buffer);</span><br><span class="line">                        <span class="title class_">JsonNode</span> jsonNode = <span class="title function_">readNode</span>(charBuffer.<span class="title function_">toString</span>());</span><br><span class="line">                        <span class="title class_">JsonNode</span> payload = jsonNode.<span class="title function_">get</span>(<span class="string">"payload"</span>);</span><br><span class="line">                        <span class="title class_">String</span> text = payload.<span class="title function_">toString</span>();</span><br><span class="line">                        <span class="title class_">String</span> content = <span class="title class_">AesUtils</span>.<span class="property">X</span>.<span class="title function_">encrypt</span>(text);</span><br><span class="line">                        log.<span class="title function_">info</span>(<span class="string">"修改响应体payload,修改前:{},修改后:{}"</span>, text, content);</span><br><span class="line">                        <span class="title function_">setPayloadTextNode</span>(content, jsonNode);</span><br><span class="line">                        <span class="keyword">return</span> bufferFactory.<span class="title function_">wrap</span>(jsonNode.<span class="title function_">toString</span>().<span class="title function_">getBytes</span>(<span class="title class_">StandardCharsets</span>.<span class="property">UTF_8</span>));</span><br><span class="line">                    }));</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">super</span>.<span class="title function_">writeWith</span>(body);</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private <span class="keyword">void</span> <span class="title function_">rewritePayloadNode</span>(<span class="params"><span class="built_in">String</span> text, JsonNode root</span>) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="title class_">JsonNode</span> node = objectMapper.<span class="title function_">readTree</span>(text);</span><br><span class="line">            <span class="title class_">ObjectNode</span> objectNode = (<span class="title class_">ObjectNode</span>) root;</span><br><span class="line">            objectNode.<span class="title function_">set</span>(<span class="string">"payload"</span>, node);</span><br><span class="line">        } <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private <span class="keyword">void</span> <span class="title function_">setPayloadTextNode</span>(<span class="params"><span class="built_in">String</span> text, JsonNode root</span>) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="title class_">ObjectNode</span> objectNode = (<span class="title class_">ObjectNode</span>) root;</span><br><span class="line">            objectNode.<span class="title function_">set</span>(<span class="string">"payload"</span>, <span class="keyword">new</span> <span class="title class_">TextNode</span>(text));</span><br><span class="line">        } <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private <span class="title class_">JsonNode</span> <span class="title function_">readNode</span>(<span class="params"><span class="built_in">String</span> <span class="keyword">in</span></span>) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">return</span> objectMapper.<span class="title function_">readTree</span>(<span class="keyword">in</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    private <span class="keyword">class</span> <span class="title class_">DataBufferHolder</span> {</span><br><span class="line"></span><br><span class="line">        <span class="title class_">DataBuffer</span> dataBuffer;</span><br><span class="line">        int length;</span><br><span class="line">    }</span><br><span class="line">}  </span><br></pre></td></tr></table></figure><p>先准备一份密文：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Map</span>&lt;<span class="title class_">String</span>, <span class="title class_">Object</span>&gt; json = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">8</span>);</span><br><span class="line">json.<span class="title function_">put</span>(<span class="string">"serialNumber"</span>, <span class="string">"请求流水号"</span>);</span><br><span class="line"><span class="title class_">String</span> content = <span class="string">"{\"name\": \"doge\"}"</span>;</span><br><span class="line">json.<span class="title function_">put</span>(<span class="string">"payload"</span>, <span class="title class_">AesUtils</span>.<span class="property">X</span>.<span class="title function_">encrypt</span>(content));</span><br><span class="line"><span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().<span class="title function_">writeValueAsString</span>(json));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line">{<span class="string">"serialNumber"</span>:<span class="string">"请求流水号"</span>,<span class="string">"payload"</span>:<span class="string">"144e3dc734743f5709f1adf857bca473da683246fd612f86ac70edeb5f2d2729"</span>}</span><br></pre></td></tr></table></figure><p>模拟请求：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">POST</span> /order/json <span class="variable constant_">HTTP</span>/<span class="number">1.1</span></span><br><span class="line"><span class="title class_">Host</span>: <span class="attr">localhost</span>:<span class="number">9090</span></span><br><span class="line"><span class="attr">accessToken</span>: <span class="number">10086</span></span><br><span class="line"><span class="title class_">Content</span>-<span class="title class_">Type</span>: application/json</span><br><span class="line"><span class="title class_">User</span>-<span class="title class_">Agent</span>: <span class="title class_">PostmanRuntime</span>/<span class="number">7.13</span><span class="number">.0</span></span><br><span class="line"><span class="title class_">Accept</span>: *<span class="comment">/*</span></span><br><span class="line"><span class="comment">Cache-Control: no-cache</span></span><br><span class="line"><span class="comment">Postman-Token: bda07fc3-ea1a-478c-b4d7-754fe6f37200,634734d9-feed-4fc9-ba20-7618bd986e1c</span></span><br><span class="line"><span class="comment">Host: localhost:9090</span></span><br><span class="line"><span class="comment">cookie: customCookieName=customCookieValue</span></span><br><span class="line"><span class="comment">accept-encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">content-length: 104</span></span><br><span class="line"><span class="comment">Connection: keep-alive</span></span><br><span class="line"><span class="comment">cache-control: no-cache</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">{</span></span><br><span class="line"><span class="comment">    "serialNumber": "请求流水号",</span></span><br><span class="line"><span class="comment">    "payload": "FE49xzR0P1cJ8a34V7ykc9poMkb9YS+GrHDt618tJyk="</span></span><br><span class="line"><span class="comment">}</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">// 响应结果</span></span><br><span class="line"><span class="comment">{</span></span><br><span class="line"><span class="comment">    "serialNumber": "请求流水号",</span></span><br><span class="line"><span class="comment">    "payload": "oo/K1igg2t/S8EExkBVGWOfI1gAh5pBpZ0wyjNPW6e8="   # &lt;--- 解密后：{"name":"doge","age":26}</span></span><br><span class="line"><span class="comment">}</span></span><br></pre></td></tr></table></figure><p>遇到的问题：</p><ul><li><strong>必须实现<code>Ordered</code>接口，返回一个小于-1的order值，这是因为<code>NettyWriteResponseFilter</code>的order值为-1</strong>，我们需要覆盖返回响应体的逻辑，自定义的<code>GlobalFilter</code>必须比<code>NettyWriteResponseFilter</code>优先执行。</li><li>网关每次重启之后，第一个请求总是无法从原始的<code>ServerHttpRequest</code>读取到有效的Body，准确来说出现的现象是<code>NettyRoutingFilter</code>调用<code>ServerHttpRequest#getBody()</code>的时候获取到一个空的对象，导致空指针；奇怪的是从第二个请求开始就能正常调用。<strong>笔者把</strong><code>**Spring Cloud Gateway**</code><strong>的版本降低到</strong><code>**Finchley.SR3**</code><strong>，</strong><code>**Spring Boot**</code><strong>的版本降低到</strong><code>**2.0.8.RELEASE**</code><strong>，问题不再出现，初步确定是</strong><code>**Spring Cloud Gateway**</code><strong>版本升级导致的兼容性问题或者是BUG</strong>。</li></ul><p>最重要的是用到了<code>ServerHttpResponse</code>装饰器<code>ServerHttpResponseDecorator</code>，主要覆盖写入响应体数据缓冲区的部分，至于怎么处理其他逻辑需要自行考虑，这里只是做一个简单的示范。一般的代码逻辑如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ServerHttpResponse</span> response = exchange.<span class="title function_">getResponse</span>();</span><br><span class="line"><span class="title class_">ServerHttpResponseDecorator</span> responseDecorator = <span class="keyword">new</span> <span class="title class_">ServerHttpResponseDecorator</span>(response) {</span><br><span class="line"></span><br><span class="line">    @<span class="title class_">Override</span></span><br><span class="line">    public <span class="title class_">Mono</span>&lt;<span class="title class_">Void</span>&gt; <span class="title function_">writeWith</span>(<span class="params">Publisher&lt;? <span class="keyword">extends</span> DataBuffer&gt; body</span>) {</span><br><span class="line">        <span class="keyword">if</span> (body <span class="keyword">instanceof</span> <span class="title class_">Flux</span>) {</span><br><span class="line">            <span class="title class_">Flux</span>&lt;? <span class="keyword">extends</span> <span class="title class_">DataBuffer</span>&gt; flux = (<span class="title class_">Flux</span>&lt;? <span class="keyword">extends</span> <span class="title class_">DataBuffer</span>&gt;) body;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">super</span>.<span class="title function_">writeWith</span>(flux.<span class="title function_">map</span>(buffer -&gt; {</span><br><span class="line">			<span class="comment">// buffer就是原始的响应数据的缓冲区</span></span><br><span class="line">            <span class="comment">// 下面处理完毕之后返回新的响应数据的缓冲区即可</span></span><br><span class="line">            <span class="keyword">return</span> bufferFactory.<span class="title function_">wrap</span>(...);</span><br><span class="line">        }));</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">super</span>.<span class="title function_">writeWith</span>(body);</span><br><span class="line">}</span><br><span class="line">};</span><br><span class="line"><span class="keyword">return</span> chain.<span class="title function_">filter</span>(exchange.<span class="title function_">mutate</span>().<span class="title function_">response</span>(responseDecorator).<span class="title function_">build</span>());</span><br></pre></td></tr></table></figure><h2 id="参考文献">参考文献</h2><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/wpc2018/article/details/122634049">https://blog.csdn.net/wpc2018/article/details/122634049</a> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.jianshu.com/p/7d80b94068b3">https://www.jianshu.com/p/7d80b94068b3</a> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/yhj_911/article/details/119540000">https://blog.csdn.net/yhj_911/article/details/119540000</a> <a target="_blank" rel="noopener external nofollow noreferrer" href="http://bjqianye.cn/detail/6845.html">http://bjqianye.cn/detail/6845.html</a> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/hao134838/article/details/110824092">https://blog.csdn.net/hao134838/article/details/110824092</a> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/hao134838/article/details/110824092">https://blog.csdn.net/hao134838/article/details/110824092</a> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/weixin_34096182/article/details/91436704">https://blog.csdn.net/weixin_34096182/article/details/91436704</a> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/fly910905/article/details/121682625">https://blog.csdn.net/fly910905/article/details/121682625</a></p></article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/avatar.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/avatar.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">Junpengzhou</div><div class="post-copyright__author_desc">Junpengzhou's Blog, Welcome!</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://www.junpengzhou.top/article/34ed37b6.html">原创</a><a class="post-copyright-title"><span onclick='rm.copyPageUrl("https://www.junpengzhou.top/article/34ed37b6.html")'>Spring Reactor实战之Mono与Flux</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/%E5%BE%AE%E4%BF%A1%E6%94%B6%E6%AC%BE%E7%A0%812.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/%E5%BE%AE%E4%BF%A1%E6%94%B6%E6%AC%BE%E7%A0%812.png" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/%E6%94%AF%E4%BB%98%E5%AE%9D%E6%94%B6%E6%AC%BE%E7%A0%812.png" rel="external nofollow noreferrer" target="_blank"><img class="post-qr-code-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/%E6%94%AF%E4%BB%98%E5%AE%9D%E6%94%B6%E6%AC%BE%E7%A0%812.png" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display:none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://www.junpengzhou.top/article/34ed37b6.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=Spring Reactor实战之Mono与Flux&amp;url=https://www.junpengzhou.top/article/34ed37b6.html&amp;pic=https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/%E7%BA%BF%E6%9D%A1%E5%B0%8F%E7%8B%97-cover.webp" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl(){var e=window.location.href,t=document.createElement("input");t.setAttribute("value",e),document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999),document.execCommand("copy"),document.body.removeChild(t)}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.junpengzhou.top" target="_blank">AlphaDog</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Java/"><span class="tags-punctuation"><i class="anzhiyufont anzhiyu-icon-tag"></i></span> Java<span class="tagsPageCount">5</span></a><a class="post-meta__box__tags" href="/tags/Spring/"><span class="tags-punctuation"><i class="anzhiyufont anzhiyu-icon-tag"></i></span> Spring<span class="tagsPageCount">2</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/%E6%B2%B3%E7%95%94%E7%9A%84%E9%83%81%E9%87%91%E9%A6%99-cover.webp?_r_=58f68730-2b7c-e8c9-6a66-3a05357cb580" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/article/35b1d86e.html"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/spring%E7%87%95%E5%AD%90-cover.webp" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Spring5+的WebClient使用指南</div></div></a></div><div class="next-post pull-right"><a href="/article/d0ee7058.html"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/%E6%B2%B3%E7%95%94%E7%9A%84%E9%83%81%E9%87%91%E9%A6%99-cover.webp?_r_=58f68730-2b7c-e8c9-6a66-3a05357cb580" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">响应式编程与异步编程和多线程编程的关系</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size:1.5rem;margin-right:4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/article/35b1d86e.html" title="Spring5+的WebClient使用指南"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/spring%E7%87%95%E5%AD%90-cover.webp" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-12-11</div><div class="title">Spring5+的WebClient使用指南</div></div></a></div><div><a href="/article/6cdabc61.html" title="JAVA21新特性-虚拟线程的使用"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/%E7%BA%BF%E6%9D%A1%E5%B0%8F%E7%8B%97%E6%B0%B4%E4%B8%AD%E7%8E%A9-cover.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-09-03</div><div class="title">JAVA21新特性-虚拟线程的使用</div></div></a></div><div><a href="/article/fbb9694d.html" title="Spring IoC容器源码分析"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/%E7%BA%BF%E6%9D%A1%E5%B0%8F%E7%8B%97%E5%9D%90%E9%A3%9E%E6%9C%BA%E8%87%AA%E6%8B%8D-cover.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-08-14</div><div class="title">Spring IoC容器源码分析</div></div></a></div><div><a href="/article/6b8e949c.html" title="Spring框架结构与学习重点"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/Spring%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93-cover.webp" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-08-13</div><div class="title">Spring框架结构与学习重点</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i> <span>评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)" rel="external nofollow noreferrer" style="display:none">匿名评论</a><a href="/privacy" style="margin-left:4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/avatar.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"><div class="author-status"><img class="g-status" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"></div></div><div class="author-info__description">Useful, interesting, and meaningful</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Junpengzhou</h1><div class="author-info__desc">Junpengzhou's Blog, Welcome!</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/19265913" rel="external nofollow noreferrer" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a><a class="social-icon faa-parent animated-hover" href="mailto:jeepzhou11@163.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="social-icon faa-parent animated-hover" href="/atom.xml" target="_blank" title="RSS"><i class="anzhiyufont anzhiyu-icon-rss"></i></a><a class="social-icon faa-parent animated-hover" href="https://mars.nasa.gov/participate/send-your-name/future/certificate/751767460870" rel="external nofollow noreferrer" target="_blank" title="NASA"><i class="anzhiyufont anzhiyu-icon-rocket"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B%E6%A6%82%E8%BF%B0"><span class="toc-text">响应式编程概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86"><span class="toc-text">背景知识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B"><span class="toc-text">什么是响应式编程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Ejava8%E5%AE%9E%E7%8E%B0%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F"><span class="toc-text">基于Java8实现观察者模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAobservable"><span class="toc-text">创建一个Observable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-reactor-%E5%AE%9E%E7%8E%B0"><span class="toc-text">基于 Reactor 实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%93%8D%E5%BA%94%E6%B5%81%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-text">响应流的特点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#publisherflux%E5%92%8Cmono"><span class="toc-text">Publisher&#x2F;Flux和Mono</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#flux"><span class="toc-text">Flux</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="toc-text">传统数据处理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%81%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="toc-text">流式数据处理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="toc-text">反应式数据处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flux-%E7%9A%84%E5%88%9B%E5%BB%BAdemo"><span class="toc-text">Flux 的创建Demo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mono"><span class="toc-text">Mono</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86-1"><span class="toc-text">传统数据处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#optional%E7%9A%84%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F"><span class="toc-text">Optional的处理方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86-1"><span class="toc-text">反应式数据处理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mono%E7%9A%84%E5%88%9B%E5%BB%BAdemo"><span class="toc-text">Mono的创建Demo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flux%E5%92%8Cmono%E6%80%BB%E7%BB%93"><span class="toc-text">Flux和Mono总结</span></a></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E7%BC%96%E7%A8%8B"><span class="toc-text">函数编程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E7%BC%96%E7%A8%8B%E6%8E%A5%E5%8F%A3"><span class="toc-text">函数编程接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0%E7%BC%96%E7%A8%8B%E7%A4%BA%E4%BE%8B"><span class="toc-text">常用函数编程示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flux%E7%B1%BB%E4%B8%AD%E7%9A%84%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95"><span class="toc-text">Flux类中的静态方法：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84%E5%88%9B%E5%BB%BA%E6%96%B9%E6%B3%95"><span class="toc-text">简单的创建方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82%E7%9A%84%E5%BA%8F%E5%88%97%E5%88%9B%E5%BB%BA-generate"><span class="toc-text">复杂的序列创建 generate()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82%E7%9A%84%E5%BA%8F%E5%88%97%E5%88%9B%E5%BB%BA-create"><span class="toc-text">复杂的序列创建 create()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mono%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95"><span class="toc-text">Mono静态方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="toc-text">操作符</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%AC%A6buffer%E5%92%8Cbuffertimeout"><span class="toc-text">操作符buffer和bufferTimeout</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%AC%A6filter"><span class="toc-text">操作符Filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%AC%A6zipwith"><span class="toc-text">操作符zipWith</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%AC%A6take"><span class="toc-text">操作符take</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%AC%A6reduce%E5%92%8Creducewith"><span class="toc-text">操作符reduce和reduceWith</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%AC%A6merge%E5%92%8Cmergesequential"><span class="toc-text">操作符merge和mergeSequential</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%AC%A6flatmap%E5%92%8Cflatmapsequential"><span class="toc-text">操作符flatMap和flatMapSequential</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%AC%A6concatmap"><span class="toc-text">操作符concatMap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%AC%A6combinelatest"><span class="toc-text">操作符combineLatest</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86"><span class="toc-text">消息处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E5%99%A8scheduler"><span class="toc-text">调度器Scheduler</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-text">测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95"><span class="toc-text">调试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95"><span class="toc-text">日志记录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%B7%E7%83%AD%E5%BA%8F%E5%88%97"><span class="toc-text">冷热序列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#serverwebexchange%E4%BA%A4%E6%8D%A2%E6%9C%BA"><span class="toc-text">ServerWebExchange交换机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#serverwebexchange%E4%B8%8E%E8%BF%87%E6%BB%A4%E5%99%A8%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-text">ServerWebExchange与过滤器的关系：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%90%86%E8%A7%A3serverwebexchange"><span class="toc-text">理解ServerWebExchange</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#serverwebexchange%E6%8E%A5%E5%8F%A3"><span class="toc-text">ServerWebExchange接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#serverwebexchangemutate%E6%96%B9%E6%B3%95"><span class="toc-text">ServerWebExchange#mutate()方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#serverhttprequest%E6%8E%A5%E5%8F%A3"><span class="toc-text">ServerHttpRequest接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#serverhttpresponse%E6%8E%A5%E5%8F%A3"><span class="toc-text">ServerHttpResponse接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#serverwebexchangeutils%E5%92%8C%E4%B8%8A%E4%B8%8B%E6%96%87%E5%B1%9E%E6%80%A7"><span class="toc-text">ServerWebExchangeUtils和上下文属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E8%AF%B7%E6%B1%82%E4%BD%93"><span class="toc-text">修改请求体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%93%8D%E5%BA%94%E4%BD%93"><span class="toc-text">修改响应体</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-text">参考文献</span></a></li></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/article/d0ee7058.html" title="响应式编程与异步编程和多线程编程的关系"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/%E6%B2%B3%E7%95%94%E7%9A%84%E9%83%81%E9%87%91%E9%A6%99-cover.webp?_r_=58f68730-2b7c-e8c9-6a66-3a05357cb580" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="响应式编程与异步编程和多线程编程的关系"></a><div class="content"><a class="title" href="/article/d0ee7058.html" title="响应式编程与异步编程和多线程编程的关系">响应式编程与异步编程和多线程编程的关系</a><time datetime="2024-12-17T08:25:38.000Z" title="发表于 2024-12-17 16:25:38">2024-12-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/34ed37b6.html" title="Spring Reactor实战之Mono与Flux"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/%E7%BA%BF%E6%9D%A1%E5%B0%8F%E7%8B%97-cover.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Spring Reactor实战之Mono与Flux"></a><div class="content"><a class="title" href="/article/34ed37b6.html" title="Spring Reactor实战之Mono与Flux">Spring Reactor实战之Mono与Flux</a><time datetime="2024-12-17T07:33:24.000Z" title="发表于 2024-12-17 15:33:24">2024-12-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/35b1d86e.html" title="Spring5+的WebClient使用指南"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/spring%E7%87%95%E5%AD%90-cover.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Spring5+的WebClient使用指南"></a><div class="content"><a class="title" href="/article/35b1d86e.html" title="Spring5+的WebClient使用指南">Spring5+的WebClient使用指南</a><time datetime="2024-12-11T06:29:31.000Z" title="发表于 2024-12-11 14:29:31">2024-12-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/af15a4c5.html" title="JVM系列-CMS垃圾回收详解"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/%E5%A4%8F%E6%97%A5%E8%8D%B7%E5%8F%B6%E4%B8%8B%E6%BD%9C%E6%B0%B4-cover.webp?_r_=8a696b00-8c71-87f4-74b4-80fd53116ed0" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="JVM系列-CMS垃圾回收详解"></a><div class="content"><a class="title" href="/article/af15a4c5.html" title="JVM系列-CMS垃圾回收详解">JVM系列-CMS垃圾回收详解</a><time datetime="2024-12-06T09:07:10.000Z" title="发表于 2024-12-06 17:07:10">2024-12-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/1a8ea7f5.html" title="JVM系列-ZGC垃圾回收详解"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/%E7%94%B5%E5%8A%A8%E8%BD%A6%E9%AA%91%E8%A1%8C%E8%83%8C%E6%99%AF-cover.png?_r_=72cdb988-f287-77ab-3c0f-c3803a4cc899" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="JVM系列-ZGC垃圾回收详解"></a><div class="content"><a class="title" href="/article/1a8ea7f5.html" title="JVM系列-ZGC垃圾回收详解">JVM系列-ZGC垃圾回收详解</a><time datetime="2024-12-06T09:06:46.000Z" title="发表于 2024-12-06 17:06:46">2024-12-06</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="mailto:jeepzhou11@163.com" rel="external nofollow noreferrer" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://weibo.com/u/5441665984" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><a class="deal_link" href="/atom.xml" title="RSS"><i class="anzhiyufont anzhiyu-icon-rss"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0,500)" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/avatar.png" size="50px"><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/junpengzhou" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener external nofollow noreferrer" href="https://space.bilibili.com/19265913" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a><a class="deal_link" href="/copyright" title="CC"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i></a></div><div class="copyright">&copy;2020 - 2024 By Junpengzhou</div><div class="footer_custom_text">学习是一种信仰，分享是一种快乐！</div><div id="anzhiyu-footer"><div class="footer-group"><div class="footer-title">服务</div><div class="footer-links"><a class="footer-item" title="51la统计" target="_blank" rel="noopener external nofollow noreferrer" href="https://v6.51.la/">51la统计</a><a class="footer-item" title="十年之约" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.foreverblog.cn/">十年之约</a><a class="footer-item" title="开往" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/travellings-link/travellings">开往</a></div></div><div class="footer-group"><div class="footer-title">虫洞</div><div class="footer-links"><a class="footer-item" title="了解虫洞" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.foreverblog.cn/notice/16.html">了解虫洞</a><a class="footer-item" title="穿梭虫洞" target="_blank" rel="noopener external nofollow noreferrer" href="https://www.foreverblog.cn/go.html">穿梭虫洞</a><a class="footer-item" title="虫洞中文网" target="_blank" rel="noopener external nofollow noreferrer" href="https://wormholechn.medium.com/">虫洞中文网</a></div></div><div class="footer-group"><div class="footer-title">导航</div><div class="footer-links"><a class="footer-item" title="即刻短文" href="/essay/">即刻短文</a><a class="footer-item" title="友链文章" href="/fcircle/">友链文章</a><a class="footer-item" title="留言板" href="/comments/">留言板</a></div></div><div class="footer-group"><div class="footer-title">协议</div><div class="footer-links"><a class="footer-item" title="隐私协议" href="/privacy/">隐私协议</a><a class="footer-item" title="Cookies" href="/cookies/">Cookies</a><a class="footer-item" title="版权协议" href="/copyright/">版权协议</a></div></div><div class="footer-group"><div class="footer-title-group"><div class="footer-title">友链</div><a class="random-friends-btn" id="footer-random-friends-btn" href="javascript:addFriendLinksInFooter();" rel="external nofollow noreferrer" title="换一批友情链接"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i></a></div><div class="footer-links" id="friend-links-in-footer"></div></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站由Hexo驱动" title="本站由Hexo驱动"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt="本站由Hexo驱动"></a><a class="github-badge" target="_blank" href="https://about.gitlab.com/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站项目由Gitlab托管" title="本站项目由Gitlab托管"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Source-Gitlab-blue?style=flat&amp;logo=gitlab" alt="本站项目由Gitlab托管"></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a><a class="github-badge" target="_blank" href="https://www.foreverblog.cn/go.html" rel="external nofollow noreferrer" style="margin-inline:5px" data-title="穿梭虫洞-随机访问十年之约友链博客" title="穿梭虫洞-随机访问十年之约友链博客"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.foreverblog.cn/wormhole_4_tp.gif" alt="穿梭虫洞-随机访问十年之约友链博客"></a></p></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">32</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">12</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">2</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" rel="external nofollow noreferrer" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="/" title="博客"><img class="back-menu-item-icon" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/jp-blog-favicon.ico" alt="博客"><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">关于</div><div class="back-menu-list"><a class="back-menu-item" href="/about/" title="关于作者"><img class="back-menu-item-icon" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://junpengzhou-1305658609.cos.ap-nanjing.myqcloud.com/blog/avatar.png" alt="关于作者"><span class="back-menu-item-text">关于作者</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size:.9em"></i> <span>总览</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i> <span>分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i> <span>标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>分享</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size:.9em"></i> <span>番剧分享</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/books/"><i class="anzhiyufont anzhiyu-icon-book faa-tada" style="font-size:.9em"></i> <span>读书分享</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/movies/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i> <span>电影分享</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/games/"><i class="anzhiyufont anzhiyu-icon-dice faa-tada" style="font-size:.9em"></i> <span>游戏分享</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/songs/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i> <span>音乐分享</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size:.9em"></i> <span>好物分享</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i> <span>友情链接</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><i class="anzhiyufont anzhiyu-icon-artstation faa-tada" style="font-size:.9em"></i> <span>博客快讯</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fishpound/"><i class="anzhiyufont anzhiyu-icon-fish faa-tada" style="font-size:.9em"></i> <span>博客鱼塘</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i> <span>留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><span>关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i> <span>关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i> <span>网站公告</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i> <span>随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Excel%E6%8A%80%E5%B7%A7/" style="font-size:.88rem">Excel技巧<sup>1</sup></a><a href="/tags/Java/" style="font-size:.88rem">Java<sup>5</sup></a><a href="/tags/Java-JVM/" style="font-size:.88rem">Java, JVM<sup>1</sup></a><a href="/tags/Markdown/" style="font-size:.88rem">Markdown<sup>1</sup></a><a href="/tags/Spring/" style="font-size:.88rem">Spring<sup>2</sup></a><a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size:.88rem">中间件<sup>1</sup></a><a href="/tags/%E5%89%8D%E7%AB%AF%E6%8A%80%E6%9C%AF/" style="font-size:.88rem">前端技术<sup>1</sup></a><a href="/tags/%E5%BB%BA%E7%AB%99%E7%BB%8F%E9%AA%8C/" style="font-size:.88rem">建站经验<sup>7</sup></a><a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size:.88rem">操作系统<sup>1</sup></a><a href="/tags/%E6%97%A5%E5%B8%B8%E8%A7%81%E9%97%BB/" style="font-size:.88rem">日常见闻<sup>1</sup></a><a href="/tags/%E6%BA%90%E4%BB%A3%E7%A0%81%E7%AE%A1%E7%90%86/" style="font-size:.88rem">源代码管理<sup>1</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/" style="font-size:.88rem">软件安装<sup>1</sup></a></div></div><hr></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch-commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" rel="external nofollow noreferrer" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8978256571" server="tencent" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr><div id="algolia-search-results"><div id="algolia-hits"><a class="tag-list" href="/tags/%E5%BB%BA%E7%AB%99%E7%BB%8F%E9%AA%8C" title="建站经验">建站经验</a><a class="tag-list" href="/tags/Markdown" title="Markdown">Markdown</a><a class="tag-list" href="/tags/Java" title="Java">Java</a><a class="tag-list" href="/tags/SpringCloud" title="SpringCloud">SpringCloud</a></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size:1rem"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display:none"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/pangu/4.0.7/pangu.min.js").then((()=>{pangu.autoSpacingPage()}))}function panguInit(){panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script async src="/anzhiyu/random.js"></script><script src="https://cdn.cbd.int/algoliasearch@4.18.0/dist/algoliasearch-lite.umd.js"></script><script src="https://npm.elemecdn.com/instantsearch.js@latest/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script><div class="js-pjax"><script>(()=>{const e=document.querySelectorAll("#article-container .mermaid-wrap");if(0===e.length)return;const t=()=>{window.loadMermaid=!0;const t="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";Array.from(e).forEach(((e,n)=>{const d=e.firstElementChild,r="mermaid-"+n,a="%%{init:{ 'theme':'"+t+"'}}%%\n"+d.textContent,i=mermaid.render(r,a);var m;"string"==typeof i?(m=i,d.insertAdjacentHTML("afterend",m)):i.then((({svg:e})=>{d.insertAdjacentHTML("afterend",e)}))}))},n=()=>{window.loadMermaid?t():getScript("https://cdn.cbd.int/mermaid@10.2.4/dist/mermaid.min.js").then(t)};anzhiyu.addGlobalFn("themeChange",t,"mermaid"),window.pjax?n():document.addEventListener("DOMContentLoaded",n)})()</script><script>(()=>{const t=()=>{"object"==typeof twikoo?setTimeout(o,0):getScript("https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js").then(o)},o=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://twikoo.junpengzhou.top",region:"ap-shanghai",onCommentLoaded:()=>{anzhiyu.loadLightbox(document.querySelectorAll("#twikoo .tk-content img:not(.tk-owo-emotion)"))}},null)),GLOBAL_CONFIG_SITE.isPost&&(()=>{const t=document.getElementById("twikoo-count");t&&twikoo.getCommentsCount({envId:"https://twikoo.junpengzhou.top",region:"ap-shanghai",urls:[window.location.pathname],includeReply:!1}).then((o=>{t.textContent=o[0].count})).catch((t=>{console.error(t)}))})()};t()})()</script><input type="hidden" name="page-type" id="page-type" value="post"><script async src="/js/anzhiyu/comment_barrage.js"></script></div><script>window.addEventListener("load",(()=>{const e=e=>{let t="";if(e.length)for(let n=0;n<e.length;n++){t+="<div class='aside-list-item'>";{const a="data-lazy-src";t+=`<a href='${e[n].url}' class='thumbnail'><img ${a}='${e[n].avatar}' alt='${e[n].nick}'><div class='name'><span>${e[n].nick} </span></div></a>`}t+=`<div class='content'>\n        <a class='comment' href='${e[n].url}' title='${e[n].content}'>${e[n].content}</a>\n        <time datetime="${e[n].date}">${anzhiyu.diffDate(e[n].date,!0)}</time></div>\n        </div>`}else t+="没有评论";let n=document.querySelector("#card-newest-comments .aside-list");n&&(n.innerHTML=t),window.lazyLoadInstance&&window.lazyLoadInstance.update(),window.pjax&&window.pjax.refresh(n)},t=()=>{if(document.querySelector("#card-newest-comments .aside-list")){const t=saveToLocal.get("twikoo-newest-comments");t?e(JSON.parse(t)):(()=>{const t=()=>{twikoo.getRecentComments({envId:"https://twikoo.junpengzhou.top",region:"ap-shanghai",pageSize:6,includeReply:!0}).then((function(t){const n=t.map((e=>{return{content:(t=e.comment,""===t||(t=(t=(t=(t=t.replace(/<img.*?src="(.*?)"?[^\>]+>/gi,"[图片]")).replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi,"[链接]")).replace(/<pre><code>.*?<\/pre>/gi,"[代码]")).replace(/<[^>]+>/g,"")).length>150&&(t=t.substring(0,150)+"..."),t),avatar:e.avatar,nick:e.nick,url:e.url+"#"+e.id,date:new Date(e.created).toISOString()};var t}));saveToLocal.set("twikoo-newest-comments",JSON.stringify(n),10/1440),e(n)})).catch((function(e){document.querySelector("#card-newest-comments .aside-list").textContent="无法获取评论，请确认相关配置是否正确"}))};"object"==typeof twikoo?t():getScript("https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js").then(t)})()}};t(),document.addEventListener("pjax:complete",t)}))</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://npm.elemecdn.com/pjax@latest/pjax.min.js"></script><script>let pjaxSelectors=['meta[property="og:image"]','meta[property="og:title"]','meta[property="og:url"]','meta[property="og:type"]','meta[property="og:site_name"]','meta[property="og:description"]',"head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:send",(function(){if(anzhiyu.removeGlobalFnEvent("pjax"),anzhiyu.removeGlobalFnEvent("themeChange"),document.getElementById("rightside").classList.remove("rightside-show"),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")})),document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach((e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach((e=>t.setAttribute(e.name,e.value))),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)})),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll()})),document.addEventListener("pjax:error",(e=>{404===e.request.status&&pjax.loadUrl("/404.html")}))</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div><script src="https://npm.elemecdn.com/live2d-widget@3.x/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"https://npm.elemecdn.com/live2d-widget-model-wanko@1.0.5/assets/wanko.model.json"},display:{position:"left",width:150,height:300},mobile:{show:!1,scale:.5},react:{opacity:1},log:!1})</script></body></html>